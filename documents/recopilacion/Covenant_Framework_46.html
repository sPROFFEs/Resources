<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Covenant Framework</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Covenant Framework</h1><br/><p>Son frameworks que mucha gente utiliza por lo que son más fáciles de detectar por herramientas de seguridad.</p><p></p><p></p><p>Existen varios frameworks como Metasploit que automatiza muchas tareas de explotación en diferentes sistemas pero además también movimientos laterales.</p><p></p><p>Powershell empire es de los mas populares pero está desactualizado por lo que es muy fácilmente detectado.</p><p></p><p>En este caso vamos a usar Covenant escrito en .NET y nos ofrece una interfaz web y que podemos utilizar para post-explotación en sistemas windows e incorpora herramientas como Mimikatz, Rubeus, etc...</p><p></p><p><a href="https://github.com/cobbr/Covenant">https://github.com/cobbr/Covenant</a></p><p></p><p><div class="codebox"><pre><br />git clone --recurse-submodules https<span style="color:#000000;font-weight:700">://</span>github.com<span style="color:#000000;font-weight:700">/</span>cobbr<span style="color:#000000;font-weight:700">/</span>Covenant<br /><span style="color:#000000;font-weight:700">cd</span> Covenant<span style="color:#000000;font-weight:700">/</span>Covenant<br /><span style="color:#000000;font-weight:700">sudo</span> dotnet run<br /></pre></div></p><p></p><p>En caso de necesitar la versión NET 3.1</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">wget</span> https<span style="color:#000000;font-weight:700">://</span>packages.microsoft.com<span style="color:#000000;font-weight:700">/</span>config<span style="color:#000000;font-weight:700">/</span>debian<span style="color:#000000;font-weight:700">/</span>11<span style="color:#000000;font-weight:700">/</span>packages-microsoft-prod.deb -O packages-microsoft-prod.deb<br /><br /><span style="color:#000000;font-weight:700">sudo</span> dpkg -i packages-microsoft-prod.deb<br /><br /><span style="color:#000000;font-weight:700">rm</span> packages-microsoft-prod.deb<br /><br /><span style="color:#000000;font-weight:700">sudo</span> apt update<br /><br /><span style="color:#000000;font-weight:700">wget</span> http<span style="color:#000000;font-weight:700">://</span>archive.ubuntu.com<span style="color:#000000;font-weight:700">/</span>ubuntu<span style="color:#000000;font-weight:700">/</span>pool<span style="color:#000000;font-weight:700">/</span>main<span style="color:#000000;font-weight:700">/</span>o<span style="color:#000000;font-weight:700">/</span>openssl<span style="color:#000000;font-weight:700">/</span>libssl1.1_1.1.0g-2ubuntu4_amd64.deb<br /><br /><span style="color:#000000;font-weight:700">sudo</span> dpkg -i libssl1.1_1.1.0g-2ubuntu4_amd64.deb<br /><br /><span style="color:#000000;font-weight:700">sudo</span> apt <span style="color:#000000;font-weight:700">install</span> -y dotnet-sdk-3.1<br /><br /><span style="color:#000000;font-weight:700">export</span> <span style="color:#8ae234;font-weight:700">DOTNET_SYSTEM_GLOBALIZATION_INVARIANT</span>=1<br /></pre></div></p><p></p><p><img src="images/46-1.png" alt="images/46-1.png" /></p><p></p><p>Abrimos el link.</p><p></p><p>Devolvemos la máquina a la red privada.</p><p></p><p><h2>Listener:</h2></p><p></p><p>Proceso que estará escuchando por conexiones en un puerto:</p><p></p><p><img src="images/46-2.png" alt="images/46-2.png" /></p><p></p><p>Como vemos podemos hasta cifrar la transferencia con SSL lo que significa que si el IDS no está rompiendo el protocolo SSL será mucho más difícil de ser detectado.</p><p></p><p><img src="images/46-3.png" alt="images/46-3.png" /></p><p></p><p>Ahora hay que ejecutar la conexión mediante un launcher:</p><p></p><p><img src="images/46-4.png" alt="images/46-4.png" /></p><p></p><p>Modificamos el host para que primero se conecte a nuestra máquina, se descargue el payload, lo ejecute y haga la reverse shell</p><p></p><p><img src="images/46-5.png" alt="images/46-5.png" /></p><p></p><p>Suponemos que hemos inyectado el comando de alguna manera:</p><p><img src="images/46-6.png" alt="images/46-6.png" /></p><p></p><p>Recibimos por kali</p><p></p><p><img src="images/46-7.png" alt="images/46-7.png" /></p><p></p><p><img src="images/46-8.png" alt="images/46-8.png" /></p><p></p><p>No son funciones que se ejecuten en powershell sino que son implementadas en .NET por Covenant.</p><p></p><p>Por lo tanto desde aquí podemos hacer prácticamente todas las técnicas vistas anteriormente:</p><p></p><p><img src="images/46-9.png" alt="images/46-9.png" /></p><p></p><p><img src="images/46-10.png" alt="images/46-10.png" /></p><p></p><p>Con rubeus dumpeamos un ticket que esté en memoria:</p><p></p><p><img src="images/46-11.png" alt="images/46-11.png" /></p><p></p><p>Formateamos el ticket:</p><p></p><p><div class="codebox"><pre><br />doIFyDCCBcSgAwIBBaEDAgEWooIEzjCCBMphggTGMIIEwqADAgEFoQwbCkNPUlAuTE9DQUyiHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCkNPUlAuTE9DQUyjggSKMIIEhqADAgESoQMCAQKiggR4BIIEdIGFdC5wKQL+gNFrPxErg+xFO3m4f7ZqLqit9dW0b6bLQxkO<span style="color:#000000;font-weight:700">/</span>B1GncWnNt2Nr7uOc7GS3At6aiI+t9DTdC8d2GjORfUhbQHJB7Au+aSWIf3LXIa<span style="color:#000000;font-weight:700">/</span>uUFIRCkZV0NEaXWl6cCHijfE2qTQ+Nlc3Mp<span style="color:#000000;font-weight:700">/</span>8GK5GW8mh9iYoETT9Cnbpa5lIVpkLW0r2TZm3P854d9MERB2hjj2uFP9+rh5l235mGx2SCjzkPue7PdzDkpqKkWP8dvTl3+PglVjC1jG9tVSXZeEZ7xj32htXmkvFbZK5qEG0v1jEuL44<span style="color:#000000;font-weight:700">/</span>ksfPK0nKBGdYGq05w2B8DM8JW3UmT20LtinYVvb3<span style="color:#000000;font-weight:700">/</span>DaRmV3pg3aEg+yfT5r0Gl2IKIeCRb5kcdXR0UkqRH<span style="color:#000000;font-weight:700">/</span>WzqG9B+ZcJyo1kA8<span style="color:#000000;font-weight:700">/</span>3qVzgLZDQFZryFdwr7rcEV24UgVLHCaJk8tmFpVz7mP2QJNhC0L+EfNj75mhjpdmoeQ3ogbciGqP6HwAFiBKbLsXILFAiu+F6mGszIy1hrGJo60Xgb0nGHZj4X<span style="color:#000000;font-weight:700">/</span>PHlg2VTkBPFcHenpax+S43jyT<span style="color:#000000;font-weight:700">/</span>+mAWTomDgKYRaAn0mx+ETuWc4SQ7IeNvFfoOoFIIEsGdWFwdxe8CsNTF<span style="color:#000000;font-weight:700">/</span>YPJWkZuot3Ml7PynXGIUE7HYazIKNsgN8PGrjULYb+zYMiVE0MfULQZ8HhjSlKGF<span style="color:#000000;font-weight:700">/</span>y0vmwcKBd0cqSVjnPWKa0yopX93+VC3SyjNhacY314hCNK0mRtzhgbOz45cJj7AEJB0BrAXrDKhEB6R+PK2HCbAYAu2Kkjm4clc0Mr2hfQSqbVhbAKWbJGWbDjVHnwigTfCfL<span style="color:#000000;font-weight:700">/</span>mEnwfcPpBR7wQ26DTRTZBkalC+RByx2e0uUZR9YFG<span style="color:#000000;font-weight:700">/</span>KxWMPC9HHmcaHvIlwM<span style="color:#000000;font-weight:700">/</span>9fP0XHCBlZ8Abxg294d+T7TbmDZsMJdDPPDq64iuvo7I6fU8r5Ez+5UeU2xBX3VLZxRYZ8+OgW<span style="color:#000000;font-weight:700">/</span>sUgLcytLnoRgWwzVJ0ovNU3jpfvog0GBWZ0n3jSp<span style="color:#000000;font-weight:700">/</span>eGTYbh2bb6qoBB0M1AUePb4F5HFPf9nzXYcsqaq6PdRKBtR6Z<span style="color:#000000;font-weight:700">/</span>QB1lJuzv8PThsQB9ErvmhFl8N7PAj6aLcKySjG5XpOKX2fybHB0nicXbn5RKSkB2bW7YGE3pJbhwFR3PtZKcS0hw15OEsTL7Ahma9fRnnMEeigW0RsHqpReShtqYDuKf7F+LD8ZrEjktndn2m0EHuXXQCP7WklgKd<span style="color:#000000;font-weight:700">/</span>XH5w7wHD2k+PDF<span style="color:#000000;font-weight:700">/</span>6zUsuF5Hk9yD+<span style="color:#000000;font-weight:700">/</span>escBv6B6q8<span style="color:#000000;font-weight:700">/</span>hpnH406hLFlsHc<span style="color:#000000;font-weight:700">/</span>LJFuaYzfS7NySMn6V55BO57eKi+WGEMStOzUnCmWlC9h<span style="color:#000000;font-weight:700">/</span>zlB8I1IfWK0V6Tw<span style="color:#000000;font-weight:700">/</span>cy57Kbd1H0R<span style="color:#000000;font-weight:700">/</span>S<span style="color:#000000;font-weight:700">/</span>dASZp4sX4HyYXP7ZNVn63Xwdj8Dk3vXQpYC6EisU<span style="color:#000000;font-weight:700">//</span>aFns97UqZJBCS5HSDNRIZ9K4eaBJAnbivgTT8aXPClIS0dSHPyR0CIw3gpvKTu7PsmBgFIX0Kkc3<span style="color:#000000;font-weight:700">/</span>iI6ARyiDmcXxaI7TceDdqv8tguQUovMSZ<span style="color:#000000;font-weight:700">/</span>DfVWwT7BKW229ztqcfLqooMZbHQ2NmO+o3w0p2lmOMI3iaZDPWAqzO6OB5TCB4qADAgEAooHaBIHXfYHUMIHRoIHOMIHLMIHIoCswKaADAgESoSIEIOnmeBVyV3TJWkRbmMJs8yqGIBFirIWrbYFVT5LWRAaloQwbCkNPUlAuTE9DQUyiGjAYoAMCAQGhETAPGw1BZG1pbmlzdHJhZG9yowcDBQBA4QAApREYDzIwMjQwMzA1MTU1MzE3WqYRGA8yMDI0MDMwNjAxNTMxN1qnERgPMjAyNDAzMTIxNTUzMTdaqAwbCkNPUlAuTE9DQUypHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCkNPUlAuTE9DQUw=<br /></pre></div></p><p></p><p><img src="images/46-12.png" alt="images/46-12.png" /></p><p></p><p><img src="images/46-13.png" alt="images/46-13.png" /></p><p></p><p><img src="images/46-14.png" alt="images/46-14.png" /></p><p></p><p><img src="images/46-15.png" alt="images/46-15.png" /></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
