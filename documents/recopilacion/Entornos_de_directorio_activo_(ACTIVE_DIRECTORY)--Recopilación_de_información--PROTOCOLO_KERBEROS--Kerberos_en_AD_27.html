<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Kerberos en AD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Kerberos en AD</h1><br/><p><h1>¿CÓMO SE IMPLEMENTA ESTE PROTOCOLO EN ACTIVE DIRECTORY?</h1></p><p></p><p>Durante el proceso de autenticación de Kerberos se utilizan ciertos nombres que están asociados con AD.S</p><p></p><p><h2>Paso por paso</h2>:</p><p></p><p>A la hora de arrancar nuestra máquina WS01,WS02,... cualquiera dentro del dominio, en el prompt del login inicial es donde comienza todo este proceso y donde el usuario consigue su <strong>TicketGrantingTicket(TGT)</strong>.</p><p></p><p>Abrimos Wireshark y lo ponemos a capturar en la red privada del domino.</p><p></p><p>Iniciamos sesión en el WS01</p><p></p><p><img src="images/27-1.png" alt="images/27-1.png" /></p><p></p><p>En wireshark filtramos por Kerberos y vemos:</p><p></p><p><img src="images/27-2.png" alt="images/27-2.png" /></p><p>Este primer paquete envía el usuario para pedir el servicio de autenticación (Autentication service request)</p><p></p><p>Si desplegamos los datos del paquete vemos que envía el nombre del usuario y los servicios que está solicitando</p><p><img src="images/27-3.png" alt="images/27-3.png" /></p><p></p><p>Todos los servicios de ActiveDirectory vienen identificados por el Service Principal Name (SPN).</p><p></p><p><img src="images/27-4.png" alt="images/27-4.png" /></p><p></p><p>Si nos fijamos el siguiente paquete es un error por parte del servicio de autenticación que indica la necesidad de una pre-autenticación y esto es porque en la nueva implementación de Kerberos v5 se añadió la comprobación de usuario necesitando un <strong>TimeStamp</strong> cifrado con el password del usuario.</p><p></p><p><img src="images/27-5.png" alt="images/27-5.png" /></p><p></p><p>El usuario manda otra petición pero esta vez con un timestamp cifrado.</p><p></p><p><img src="images/27-6.png" alt="images/27-6.png" /></p><p></p><p>El servicio responde con un paquete Autentication service replay (AS-REP):</p><p><img src="images/27-7.png" alt="images/27-7.png" /></p><p></p><p>En su contenido vemos que adjunta el ticket que veíamos previamente y otro dato encriptado que se trata de sessionkey cifrada con el password del usuario</p><p><img src="images/27-8.png" alt="images/27-8.png" /></p><p></p><p>Esta información se descifra en el usuario y el usuario envía un paquete TGS-REQ (ticket granting service request):</p><p></p><p><img src="images/27-9.png" alt="images/27-9.png" /></p><p></p><p>Como veíamos antes esto contiene el TGT que recibió antes y un autenticator</p><p><img src="images/27-10.png" alt="images/27-10.png" /></p><p></p><p>Del servicio recibimos un TGS-REP (ticket granting service replay)</p><p><img src="images/27-11.png" alt="images/27-11.png" /></p><p></p><p>Este paquete contiene el ticket de servicio con el nombre del mismo y el equipo desde el que solicita y unos datos cifrados que son la SessionKey para luego interactuar con el servicio del host.</p><p><img src="images/27-12.png" alt="images/27-12.png" /></p><p></p><p>Si nos fijamos el usuario hace otra petición para un nuevo ticket para el servicio de LDAP en el host del controlador del dominio.</p><p></p><p><img src="images/27-13.png" alt="images/27-13.png" /></p><p></p><p><img src="images/27-14.png" alt="images/27-14.png" /></p><p></p><p>El servicio responde con el nuevo ticket:</p><p></p><p><img src="images/27-15.png" alt="images/27-15.png" /></p><p></p><p><img src="images/27-16.png" alt="images/27-16.png" /></p><p></p><p></p><p></p><p></p><p></p><p>A partir de aqui se observa el tráfico con los servicios que ya se están solicitando del host:</p><p></p><p><img src="images/27-17.png" alt="images/27-17.png" /></p><p></p><p>En el primer paquete vemos que </p><p><img src="images/27-18.png" alt="images/27-18.png" /></p><p><img src="images/27-19.png" alt="images/27-19.png" /></p><p></p><p>Le envía el ticket de servicio para LDAP y el autenticator.</p><p>El servicio envía un paquete de autenticación mutua:</p><p></p><p><img src="images/27-20.png" alt="images/27-20.png" /></p><p></p><p><img src="images/27-21.png" alt="images/27-21.png" /></p><p></p><p>Que si recordamos son datos como un timestamp cifrados con la sessionkey que el usuario ya posee.</p><p></p><p></p><p></p><p></p><p><h2>Lo importante a tener en cuenta</h2>:</p><p></p><p>Todo esto se lleva a cabo por un usuario en el controlador de dominio. Este está creado por defecto y se llama krbtgt.</p><p></p><p><img src="images/27-22.png" alt="images/27-22.png" /></p><p></p><p>El KDC o KeyDistributionCenter engloba a los servicios de authentication y el ticket gratnting service. </p><p>Este usuario es el que se encarga de cifrar estos paquetes y tickets porque la clave de este usuario se trata de la clave del TGS.</p><p></p><p>La clave por defecto de este usuario es muy larga y compleja por lo que obviamente no se debería cambiar nunca a algo muy sencillo de crackear.</p><p></p><p></p><p></p><p></p><p>Si queremos ver el ServicePrincipalNames SPN, se puede observar qué servicios ofrece cada ordenador de la infraestructura y que SPN tiene asociados:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetComputer</span> <span style="color:#000000;font-weight:700">-</span>Identity WS01</pre></div></p><p></p><p><img src="images/27-23.png" alt="images/27-23.png" /></p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetComputer</span> <span style="color:#000000;font-weight:700">-</span>Identity DC01</pre></div></p><p></p><p><img src="images/27-24.png" alt="images/27-24.png" /></p></div>
</body>
</html>
