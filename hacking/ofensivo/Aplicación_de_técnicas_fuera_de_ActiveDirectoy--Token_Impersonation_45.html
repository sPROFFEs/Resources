<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Token Impersonation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Token Impersonation</h1><br/><p>Cuando nos autenticamos en un sistema windows se crea una logonsession del usuario y después podemos ejecutar procesos que llevan asociados un access token donde van asociados los privilegios para acceder a los diferentes securable objects. Ese token de acceso referencia la logon session donde estaban los credenciales.</p><p></p><p>El objetivo de esta técnica es teniendo permisos de administración locales, cogemos el token de acceso de otro usuario con una logon session activa en el sistema y vamos a utilizarlo para realizar peticiones en su nombre.</p><p></p><p></p><p>Para esto vamos a usar metasploit:</p><p></p><p><div class="codebox"><pre><br />msconsole</pre></div></p><p></p><p>Para este caso hemos llegado a obtener las credenciales o hash de empleado1.</p><p>Para esta técnica es actualmente importante desactivar el antivirus.</p><p></p><p><div class="codebox"><pre><br />use exploit<span style="color:#000000;font-weight:700">/</span>windows<span style="color:#000000;font-weight:700">/</span>smb<span style="color:#000000;font-weight:700">/</span>psexec</pre></div></p><p></p><p><img src="images/45-1.png" alt="images/45-1.png" /></p><p></p><p>En el set smbpass se podría haber introducido el hash</p><p></p><p><img src="images/45-2.png" alt="images/45-2.png" /></p><p></p><p>Actualmente somos administradores del equipo de forma local pero no de dominio.</p><p></p><p>Pero si podemos copiar tokens por lo que vamos a suponer que en la maquina hay una sesión ya sea dentro o de forma remota de un administrador de dominio por lo que hay un sessionlogon del mismo y el proceso que esté usando tiene un token con sus privilegios.</p><p></p><p><img src="images/45-3.png" alt="images/45-3.png" /></p><p></p><p></p><p>Ahora desde meterpreter:</p><p></p><p>Listamos procesos del sistema:</p><p></p><p><div class="codebox"><pre><br />meterpreter &gt; <span style="color:#000000;font-weight:700">ps</span></pre></div></p><p></p><p><img src="images/45-4.png" alt="images/45-4.png" /></p><p></p><p>Vemos el proceso que tiene el usuario administrador.</p><p></p><p>Le copiamos el process id y lo inyectamos en nuestro proceso:</p><p></p><p><div class="codebox"><pre><br />meterpreter &gt; steal_token 3924</pre></div></p><p></p><p><img src="images/45-5.png" alt="images/45-5.png" /></p><p></p><p><img src="images/45-6.png" alt="images/45-6.png" /></p><p></p><p><img src="images/45-7.png" alt="images/45-7.png" /></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p>En el caso de no poder copiar los tokens podemos migrar nuestro payload a el proceso que se esté ejecutando con el access token de ese usuario.</p><p></p><p><div class="codebox"><pre><br />meterpreter &gt; migrate 3924</pre></div></p><p></p><p><img src="images/45-8.png" alt="images/45-8.png" /></p><p></p><p><img src="images/45-9.png" alt="images/45-9.png" /></p><p></p><p>Hemos migrado nuestro payload en nuestro proceso y lo ha migrado a ese proceso del usuario objetivo.</p><p></p><p>Como observación el inyectar nuestro payload o migrar puede romper el proceso y romper la sesión en la práctica.</p></div>
</body>
</html>
