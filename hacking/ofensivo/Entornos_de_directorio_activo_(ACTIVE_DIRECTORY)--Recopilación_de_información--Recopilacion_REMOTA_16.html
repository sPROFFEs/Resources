<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Recopilacion REMOTA</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Recopilacion REMOTA</h1><br/><p></p><p><strong><h1>Nos encontramos en la siguiente situación;</h1></strong><h1> (SAM enumeration remote)</h1></p><p></p><p>Dentro de una organización con un equipo o unas credenciales de un usuario perteneciente al dominio pero sin privilegios y nuestra maquina kali.</p><p></p><p>Nuestro objetivo es recopilar información.</p><p></p><p>Para esto vamos a ver unos cuantos comandos y técnicas para recabar información a nivel local.</p><p></p><p>Para saber el usuario actual y el dominio:</p><p><div class="codebox"><pre><br /><span style="color:#888a85;font-weight:700">$env</span><span style="color:#000000;font-weight:700">:</span>Username <span style="color:#000000;font-weight:700">//</span> whoami<br /><span style="color:#888a85;font-weight:700">$env</span><span style="color:#000000;font-weight:700">:</span>UserDomain<br /></pre></div></p><p></p><p>Nombre de equipo:</p><p><div class="codebox"><pre><br /><span style="color:#888a85;font-weight:700">$env</span><span style="color:#000000;font-weight:700">:</span>ComputerName</pre></div></p><p></p><p>En versiones antiguas de windows como se mencionó anteriormente cualquier usuario de dominio sin privilegios podía enumerar la SAM de un equipo remoto:</p><p></p><p><div class="codebox"><pre><br />Get.NetLocalGroup <span style="color:#000000;font-weight:700">-</span>ComputerName WS02 <br /></pre></div></p><p></p><p>Actualmente eso no es posible si el usuario del que tenemos control no es administrador del dominio.</p><p><img src="images/16-1.png" alt="images/16-1.png" /></p><p></p><p>Si analizamos las peticiones que realiza la maquina mediante wireshark vemos lo siguiente:</p><p><img src="images/16-2.png" alt="images/16-2.png" /></p><p></p><p>El tráfico pertenece al protocolo SAMR que va sobre DCE/RPC (Distributed computing enviroment / remote procedure call) y que es utilizado por windows para realizar peticiones a muchos de sus servicios de forma local y remota.</p><p></p><p>Esto es importante para saber en que situación se consulta la SAM y en que otras se consulta el NTDS.dit del domain controler</p><p></p><p>Cuando consultemos la base de datos del domain controles se utiliza el protocolo LDAPs.</p><p></p><p>Para realizar esto sin powerview:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#729fcf;font-weight:400">Invoke-Command</span> <span style="color:#000000;font-weight:700">-</span>ScriptBlock { <span style="color:#edd400;font-weight:400">Get-LocalGroupMember</span> <span style="color:#000000;font-weight:700">-</span><span style="color:#729fcf;font-weight:400">Group</span> Administradores } <span style="color:#000000;font-weight:700">-</span>ComputerName WS02</pre></div></p><p></p><p></p><p></p><p>Si queremos saber que usuario se encuentra logueado en un sistema usamos con powerview:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetLoggedon</span></pre></div></p><p></p><p><img src="images/16-3.png" alt="images/16-3.png" /></p><p></p><p>Como dato si somos administrador del dominio podemos acceder a los discos c de los equipos pertenecientes en la siguiente ruta:</p><p><img src="images/16-4.png" alt="images/16-4.png" /></p><p></p><p>Lo que si podemos hacer es obtener las sesiones, las conexiones que se han establecido a la maquina que tenemos:</p><p></p><p><img src="images/16-5.png" alt="images/16-5.png" /></p><p></p><p>Y podemos saber que un administrador se ha conectado a nuestra maquina desde esa IP por lo que ya tenemos un potencial objetivo que si conseguimos vulnerar tendremos altas probabilidades de tener acceso administrativos.</p><p></p><p>Importante recalcar que aunque la conexión falle, por ejemplo si desde otro usuario sin privilegios intenta acceder a la carpeta compartida C$ este intento se registra igualmente:</p><p><img src="images/16-6.png" alt="images/16-6.png" /></p><p></p><p>Vemos como igualmente aparece registrado:</p><p></p><p><img src="images/16-7.png" alt="images/16-7.png" /></p><p></p><p>Si la versión es un versión antigua es necesario recordar que podemos realizar la enumeración remota SAM sin necesitar privilegios.</p><p></p><p></p><p></p><p><h3>Es posible enumerar la SAM de manera remota utilizando Kali teniendo los credenciales de un usuario valido del dominio.</h3></p><p></p><p>Para poder apuntar al dominio necesitamos configurar el DNS de la maquina linux:</p><p><img src="images/16-8.png" alt="images/16-8.png" /></p><p><img src="images/16-9.png" alt="images/16-9.png" /></p><p></p><p>Configuramos que el método solo asigne nuestra IP de forma automática e indicamos la ip del dominio y como vemos ahora si podemos apuntar al dominio </p><p></p><p><img src="images/16-10.png" alt="images/16-10.png" /></p><p></p><p>Para poder averiguar que IP corresponde a un controlador de dominio simplemente podemos hacer uso de un reconocimiento con NMAP y en función de los servicios y puertos que la maquina tenga activos podemos deducir rápidamente de que máquina se trata.</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">sudo</span> nmap -sS -n 192.168.20.0-7  </pre></div></p><p></p><p>Como vemos esto nos da bastante información:</p><p></p><p><img src="images/16-11.png" alt="images/16-11.png" /></p><p></p><p>Siendo puertos 88 y 389 de los mas reconocibles en un controlador de dominio.</p><p></p><p>Para poder enumerar SAM de forma remota en Kali vamos a usar rpcclient, una herramienta clásica que implementa los protocolos que usa windows para comunicarse con sus servicios DCE/RPC.</p><p></p><p><div class="codebox"><pre><br />rpcclient -U <span style="color:#edd400;font-weight:400">&quot;corp\empleado1%Passw0rd1&quot;</span> WS01.corp.local </pre></div></p><p></p><p>Si pulsamos TAB dos veces vemos todas las funciones disponibles.</p><p></p><p>por ejemplo:</p><p></p><p><div class="codebox"><pre><br />enumprivs</pre></div></p><p></p><p>Enumera los privilegios del usuario loggeado, pero si intentamos de nuevo enumerar la SAM de forma remota aunque sea desde kali veremos que: </p><p></p><p><div class="codebox"><pre><br />enumdomusers</pre></div></p><p></p><p><img src="images/16-12.png" alt="images/16-12.png" /></p><p></p><p>Devuelve un error que básicamente es el mismo motivo que antes y se trata de igual manera que a partir de Windows 10 1607 y WinServer2016 es necesario ser usuario con privilegios para poder hacer una enumeracion remota de SAM aunque sea desde linux.</p><p></p><p></p><p></p><p><h3>Otra herramienta es impacket</h3>:</p><p></p><p>Es un conjunto de scripts en python que implementan muchos de los protocolos que utiliza windows y además proporciona ejemplos.</p><p></p><p><img src="images/16-13.png" alt="images/16-13.png" /></p><p></p><p><div class="codebox"><pre><br />imapacket-samrdump corp<span style="color:#000000;font-weight:700">/</span>empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1@WS01.corp.local</pre></div></p><p></p><p>Si de igual forma ejecutamos un dump de SAM con un usuario sin privilegios seguiremos sin tener acceso.</p><p></p><p><img src="images/16-14.png" alt="images/16-14.png" /></p><p></p><p>Otra función de impacket interesante es:</p><p></p><p><div class="codebox"><pre><br />impacket-netview corp.local<span style="color:#000000;font-weight:700">/</span>empleado1<span style="color:#000000;font-weight:700">:</span><span style="color:#edd400;font-weight:400">&#39;Passw0rd1&#39;</span> -target WS01.corp.local</pre></div></p><p></p><p>Esto se quedará escuchando sesiones de red que se establezcan a este equipo pero de nuevo necesitaremos privilegios de administración para detectar las conexiones.</p><p></p><p></p></div>
</body>
</html>
