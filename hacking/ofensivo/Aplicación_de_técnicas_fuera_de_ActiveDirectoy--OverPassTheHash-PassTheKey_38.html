<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>OverPassTheHash/PassTheKey</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>OverPassTheHash/PassTheKey</h1><br/><p><strong><h1>PASS THE KEY</h1></strong></p><p></p><p>Con Kerberos cuando iniciamos sesión la contraseña se hashea y se almacena en memoria proceso LSAS. </p><p>El paquete autenticación Kerberos accede al hash y lo utiliza para cifrar el timestamp, tickets, etc.</p><p></p><p>Kerberos soporta varios hashes:<ul><li>RC4</li><li>AES128</li><li>AES256</li></ul></p><p></p><p>El concepto es lo mismo de passthehash de modificar el hash que cogería de forma predeterminada si pedimos un servicio con un usuario sin privilegios y modificarlo por el que indiquemos.</p><p></p><p></p><p>Con mimikatz podemos repetir el proceso de la parte anterior:</p><p></p><p><div class="codebox"><pre><br />sekurlsa<span style="color:#000000;font-weight:700">::</span>pth <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>administrador <span style="color:#000000;font-weight:700">/</span>domain<span style="color:#000000;font-weight:700">:</span>corp.local <span style="color:#000000;font-weight:700">/</span>ntlm<span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86</pre></div></p><p></p><p><img src="images/38-1.png" alt="images/38-1.png" /></p><p></p><p>Si nos fijamos nos indica que lo reemplaza en la zona de memoria del proceso LSAS que consulta el paquete de autenticación msv1_0 pero además lo copia en el paquete de autenticación kerberos.</p><p></p><p>Si por ejemplo queremos capturar un TicketGrantingTicket a nombre del usuario administrador del domino:</p><p></p><p><div class="codebox"><pre><br />rubeus.exe asktgt <span style="color:#000000;font-weight:700">/</span>domain<span style="color:#000000;font-weight:700">:</span>corp.local <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>administrador <span style="color:#000000;font-weight:700">/</span>rc4<span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86 <span style="color:#000000;font-weight:700">/</span>ptt</pre></div></p><p></p><p></p><p>OverPassTheHash se diferencia de <a href="Aplicación_de_técnicas_fuera_de_ActiveDirectoy--PassTheHash_37.html">PassTheHash</a> en que forzamos al sistema kerberos a usar una encriptación en este caso RC4 que es igual a NTLM y que por defecto no usa pero si soporta haciéndolo así creer que igualmente el usuario que pide el TGT es el administrador.</p><p></p><p></p><p>Con mimikatz podemos volcar de igual manera los hashes de kerberos almacenados en la logonsession:</p><p></p><p><div class="codebox"><pre><br />sekurlsa<span style="color:#000000;font-weight:700">::</span>ekeys</pre></div></p><p></p><p><img src="images/38-2.png" alt="images/38-2.png" /></p><p><ul><li>AES256: 3b820f5f55bdc8faa271143860bf3fb35aa5294df7d54b3c0a899c2dda0e0fe7 </li><li>RC4/NTLM: a87f3a337d73085c45f9416be5787d86 </li></ul></p><p></p><p>Encontramos los dos hashes uno en AES256 que es el que utiliza por defecto kerberos y el RC4 que es el que hemos obligado a que use en la anterior petición y es igual al NTLM.</p><p></p><p></p><p><h2>DESDE LINUX:</h2></p><p></p><p>Impacket:</p><p></p><p><div class="codebox"><pre><br />impacket-getTGT corp.local<span style="color:#000000;font-weight:700">/</span>administrador -hashes <span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86<br />impacket-getTGT corp.local<span style="color:#000000;font-weight:700">/</span>administrador -hashes <span style="color:#000000;font-weight:700">:</span>3b820f5f55bdc8faa271143860bf3fb35aa5294df7d54b3c0a899c2dda0e0fe7</pre></div></p><p></p><p></p><p></p><p><h1>EN RESUMEN</h1>:</p><p></p><p>OverPassTheHash → Utilizamos RC4 o NTLM al igual que con <a href="Aplicación_de_técnicas_fuera_de_ActiveDirectoy--PassTheHash_37.html">PassTheHash</a></p><p>PassTheKey → Utilizamos un dump de la clave AES256 que utiliza kerberos de la logonsession.</p></div>
</body>
</html>
