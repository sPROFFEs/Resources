<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Identificación ACLs vulnerables</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Identificación ACLs vulnerables</h1><br/><p><strong><h1>OBJETIVO:  A partir de un usuario sin privilegios convertirnos en un administrador del dominio.</h1></strong></p><p></p><p></p><p><h2>En este caso vamos a intentar de explotar los privilegios de acceso de ACL aprovechando pequeños permisos que tengamos sobre ciertos objetos ir expandiendo los privilegios.</h2></p><p></p><p></p><p><strong><h1>1: IDENTIFICAR ACEs QUE RESULTAN INTERESANTES PARA EXPLOTACIÓN</h1></strong></p><p></p><p>Listado de ACEs vulnerables</p><p></p><p>A continuación os indico un listado de ACEs que debemos tener en cuenta desde el punto de vista de seguridad de cara a su explotación:</p><p></p><p>    <strong>ForceChangePassword</strong>: Proporciona la capacidad de cambiar la contraseña del usuario objetivo sin conocer el valor actual. Abusado con Set-DomainUserPassword</p><p></p><p>    <strong>AddMembers:</strong> Proporciona la capacidad de añadir usuarios, grupos o equipos arbitrarios al grupo de destino. Abusado con Add-DomainGroupMember</p><p></p><p>    <strong>GenericAll:</strong> Proporciona control total del objeto, incluyendo la capacidad de añadir otros usuarios a un grupo, cambiar una contraseña de usuario sin conocer su valor actual, registrar un SPN con un objeto de usuario, etc. Abusado con Set-DomainUserPassword o Add-DomainGroupMember</p><p></p><p>    <strong>GenericWrite: </strong>Proporciona la capacidad de actualizar cualquier valor de parámetro de objeto de destino no protegido. Por ejemplo, actualizar el valor del parámetro &quot;scriptPath&quot; en un objeto de usuario de destino para hacer que ese usuario ejecute los comandos/ejecutables especificados la próxima vez que se conecte. Abusado con Set-DomainObject</p><p></p><p>    <strong>WriteOwner:</strong> Proporciona la capacidad de actualizar el propietario del objeto de destino. Una vez que el propietario del objeto ha sido cambiado a un usuario que el atacante controla, el atacante puede manipular el objeto de la manera que crea conveniente. Abusado con Set-DomainObjectOwner</p><p></p><p>    <strong>WriteDACL:</strong> Proporciona la capacidad de escribir una nueva ACE en la DACL del objeto objetivo. Por ejemplo, un atacante puede escribir una nueva ACE en la DACL del objeto de destino, dándole el &quot;control total&quot; del objeto de destino. Abusado con Add-NewADObjectAccessControlEntry</p><p></p><p>    <strong>AllExtendedRights:</strong> Proporciona la capacidad de realizar cualquier acción asociada con los derechos extendidos de Active Directory contra el objeto. Por ejemplo, añadir usuarios a un grupo y forzar el cambio de la contraseña de un usuario de destino. Se abusa con Set-DomainUserPassword o Add-DomainGroupMember</p><p></p><p>Por supuesto, esta no es la lista completa de ACEs que pueden vulnerarse, existen decenas de permisos que bajo ciertas circunstancias también pueden llegar a ser explotados.</p><p></p><p></p><p><h2>Vamos a la maquina windows comprometida, cargamos powerview y seleccionamos un objetivo:</h2></p><p></p><p>Por ejemplo vamos a listar los grupos e info: </p><p></p><p><img src="images/22-1.png" alt="images/22-1.png" /></p><p></p><p></p><p>Vamos a buscar las ACEs del grupo Admins del dominio:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-DomainObjectAcl</span> <span style="color:#000000;font-weight:700">-</span>Identity <span style="color:#edd400;font-weight:400">&quot;Admins. del dominio&quot;</span></pre></div></p><p></p><p><img src="images/22-2.png" alt="images/22-2.png" /></p><p></p><p>Lo que vemos es:<ul><li>Objeto sobre el que se aplica la ACE : OBJECTSID</li><li>El tipo de permiso : Active directory rights</li><li>Tipo de ACE : AceType</li><li>Identificador de seguridad que tiene el objeto que tiene los permisos GenericAll sobre admins del dominio</li></ul></p><p></p><p>Cada uno de esos bloques se trata de un ACE del DACL del grupo Admins del dominio.</p><p></p><p>Para convertir un SID a su nombre:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Convert-SidToName</span> <span style="color:#edd400;font-weight:400">S-1-5-21-422223421-2761745813-2535134267-512</span></pre></div></p><p></p><p>Este security identifier es el objeto que tiene privilegios sobre el identifier de arriba:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Convert-SidToName</span> <span style="color:#edd400;font-weight:400">S-1-5-18</span></pre></div></p><p><img src="images/22-3.png" alt="images/22-3.png" /></p><p></p><p>Para obtener lo más interesante aplicamos filtro:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-DomainObjectAcl</span> <span style="color:#000000;font-weight:700">-</span>Identity <span style="color:#edd400;font-weight:400">&quot;Admins. del dominio&quot;</span> | <span style="color:#729fcf;font-weight:400">select</span> @{name<span style="color:#000000;font-weight:700">=</span><span style="color:#edd400;font-weight:400">&quot;Name&quot;</span>;expression<span style="color:#000000;font-weight:700">=</span>{<span style="color:#edd400;font-weight:400">Convert-SidToName</span> <span style="color:#888a85;font-weight:700">$_</span>.SecurityIdentifier}},AceType,ActiveDirectoryRights | <span style="color:#729fcf;font-weight:400">fl</span> </pre></div></p><p></p><p>Para también formatear esos SID de forma automática.</p><p></p><p><img src="images/22-4.png" alt="images/22-4.png" /></p><p></p><p>Otro comando que proporciona todas las ACEs de los objetos dentro del dominio y muestra aquellas que tienen un valor mayor a 1000 en el SID ya que esto quiere decir que esta DACL la ha creado un administrador y no es una por defecto.</p><p>Esto es porque los grupos por defecto suelen estar bien pero los creados por administradores pueden tener errores.</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Invoke-ACLScanner</span> <span style="color:#000000;font-weight:700">-</span>ResolveGUIDs | <span style="color:#729fcf;font-weight:400">select</span> IdentityReferenceName, ObjectDN, ActiveDirectoryRights | <span style="color:#729fcf;font-weight:400">fl</span> </pre></div></p><p></p><p>Con este comando se ocupa de sacar las mas interesantes.</p><p></p><p><img src="images/22-5.png" alt="images/22-5.png" /></p><p></p><p>Como vemos el valor final del SID es mas de 1000</p><p></p><p></p><p></p><p></p><p></p><p><h1>Una mejor manera de realizar una identificación por supuesto es BLOODHOUND.</h1></p><p></p><p>Con el archivo ya en la maquina objetivo que actualmente lo haremos de forma manual desde el equipo windows WS01:</p><p></p><p><div class="codebox"><pre><br />. .<span style="color:#000000;font-weight:700">\</span>bloodhound.ps1<br /><span style="color:#edd400;font-weight:400">Invoke-BloodHound</span> <span style="color:#000000;font-weight:700">-</span>CollectionMethod All<br /></pre></div></p><p></p><p>Pasamos igual que antes el zip a Kali y lo abrimos con BloodHound.</p><p></p><p><div class="codebox"><pre><br />sudo neo4j console<br />bloodhunt<br /></pre></div></p><p></p><p>Al cargar podemos ver como ahora hay mucha más información que antes, relaciones, usuarios, hosts, ACLs...</p><p><img src="images/22-6.png" alt="images/22-6.png" /></p><p></p><p>Ahora si en análisis buscamos que busque la ruta más corta para obtener permisos de administrador:</p><p></p><p><img src="images/22-7.png" alt="images/22-7.png" /></p><p></p><p>Si hacemos click en admins del dominio y nos vamos a la información de la izquierda podemos ver:</p><p></p><p><img src="images/22-8.png" alt="images/22-8.png" /></p><p><ul><li>OUTBOUND OBJECT CONTROL: Se tratan de los privilegios que tiene este grupo sobre otros objetos</li><li>INBOUND CONTROL RIGHTS (DACLs): Los privilegios que tienen otros objetos sobre este</li></ul></p><p></p><p>Si hacemos click para saber que objetos tienen privilegios sobre este, nos damos cuenta de que hay dos grupos que los tienen esos 3 privilegios (GenericWrite, WriteOver, WriteDacl):</p><p></p><p><img src="images/22-9.png" alt="images/22-9.png" /></p><p></p><p>Esto significa que comprometiendo uno de estos dos grupos podríamos auto promocionarnos al grupo de admins del dominio.</p><p></p><p>Por lo que si nos vamos a administrators y buscamos que usuarios tiene:</p><p></p><p><img src="images/22-10.png" alt="images/22-10.png" /></p><p></p><p>Como vemos tiene varios usuarios que son por default pero además vemos que tiene uno que no es por defecto así que buscamos que miembros son usuarios del mismo:</p><p></p><p><img src="images/22-11.png" alt="images/22-11.png" /></p><p></p><p>Y como vemos tiene a estos 6 usuarios.</p><p></p></div>
</body>
</html>
