<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Password Spraying</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Password Spraying</h1><br/><p><h1>Consiste en progagar una contraseña a todos los usuarios del dominio para averiguar que usuarios tienen esa contraseña establecida.</h1></p><p></p><p>Esto es útil si encontramos una contraseña que coincide en varios usuarios podemos propagarla y verificar si esta corresponde a algún usuario más.</p><p></p><p>Esta técnica es muy intrusiva llegando al punto de poder bloquear las cuentas de usuarios del dominio ya que normalmente todos los usuarios tienen un límite de intentos fallidos.</p><p></p><p></p><p>Para empezar vamos a revisar de nuevo que usuarios hay, sus datos, descripciones, etc...</p><p></p><p>En nuestro equipo de empleado1 WS01 ejecutamos powerview:</p><p></p><p><div class="codebox"><pre><br />. .<span style="color:#000000;font-weight:700">\</span>newpower.ps1 </pre></div></p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span> | <span style="color:#729fcf;font-weight:400">select</span> name,description</pre></div></p><p></p><p><img src="images/25-1.png" alt="images/25-1.png" /></p><p></p><p>Y si nos fijamos bien</p><p></p><p><img src="images/25-2.png" alt="images/25-2.png" /></p><p></p><p>Esto es un fallo de seguridad importante que a veces se comete debido a que estas cuentas son utilizadas por mas de una persona, normalmente administradores que pueden acceder a su descripción. De esta manera pueden acceder a ella sin andar compartiendo la contraseña pero como vemos es completamente pública y cualquier usuario del dominio tiene acceso.</p><p></p><p>También encontramos pistas sobre otros usuarios como si son usuarios con replicación DSYNC etc</p><p>Además encontramos usuarios que indica son nuevos y que su contraseña es por defecto. En estos usuarios es donde debemos aprovechar, coger su contraseña y probarla en los demás por si alguna coincidiese.</p><p></p><p>Para esto vamos a utilizar un script publico llamado <a href="https://github.com/dafthack/DomainPasswordSpray">https://github.com/dafthack/DomainPasswordSpray</a></p><p></p><p>Copiamos el script y como siempre creamos un documento el WS01 para crear el .ps1</p><p></p><p>Actualmente este script para tener un error de sintaxis en estas versiones de powershell. Para solucionarlo podemos comentar la linea o arreglarla:</p><p></p><p><img src="images/25-3.png" alt="images/25-3.png" /></p><p></p><p>Buscamos la linea 261</p><p></p><p></p><p><img src="images/25-4.png" alt="images/25-4.png" /></p><p></p><p>Es un error de syntaxis que cambia en la forma en la que se indica la variable dentro de una cadena como podemos ver. Antes era <strong>$Message</strong> lo cambiamos a <strong>${Message}</strong>.</p><p></p><p>Hay algun error más, aquí los arreglo:</p><p></p><p><h3>https://github.com/dafthack/DomainPasswordSpray/issues/43</h3></p><p></p><p>Ahora si lo podemos ejecutar sin problema:</p><p></p><p><div class="codebox"><pre><br />. .<span style="color:#000000;font-weight:700">\</span>DomainSpray.ps1 </pre></div></p><p></p><p>Antes de poder ejecutar el comando de Spraying vamos a necesitar una lista de usuarios que sacamos con PowerView y guardamos en users.txt:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span> | <span style="color:#729fcf;font-weight:400">Select-Object</span> <span style="color:#000000;font-weight:700">-</span>ExpandProperty name | <span style="color:#729fcf;font-weight:400">Out-File</span> C<span style="color:#000000;font-weight:700">:\</span>Users<span style="color:#000000;font-weight:700">\</span>empleado1<span style="color:#000000;font-weight:700">\</span>Desktop<span style="color:#000000;font-weight:700">\</span>users.txt <br /></pre></div></p><p></p><p>Ahora si le pasamos la lista y la contraseña que queremos:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Invoke-DomainPasswordSpray</span> <span style="color:#000000;font-weight:700">-</span>UserList .<span style="color:#000000;font-weight:700">\</span>users.txt <span style="color:#000000;font-weight:700">-</span>Password <span style="color:#edd400;font-weight:400">&quot;DefaultPassword&quot;</span> <span style="color:#ad7fa8;font-weight:400">-Verbose</span></pre></div></p><p></p><p>Podemos probar las contraseñas que queramos pero hay que tener en cuenta que cada vez que se ejecuta se intenta ese inicio de sesión en todos los usuarios del dominio por lo que si alcanzamos el número de intentos permitido bloqueamos la cuenta a todos los usuarios del dominio.</p><p>Por supuesto también seremos detectados a la minima por los sistemas de seguirdad.</p><p></p><p><img src="images/25-5.png" alt="images/25-5.png" /></p></div>
</body>
</html>
