<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NTLM Roasting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>NTLM Roasting</h1><br/><p>Es destacar que como hemos visto en las técnicas anteriores hemos necesitado de previamente volcar la información de algún equipo para poderlas llevar a cabo y, además este usuario debía ser como mínimo administrador del sistema local.</p><p></p><p></p><p>Que ocurre cuando no tengamos acceso a un usuario con esas características podemos aprovechar debilidades que tiene el protocolo NTLM para obtener hashes y contraseñas.</p><p></p><p>Un repaso rápido al uso del protocolo NTLM:</p><p>Un usuario consume un servicio utilizando NTLM, manda la petición para consumir el servicio con su nombre de usuario, el servicio recibe la petición y le manda un <em>nonce</em> o <em>challenge</em>.</p><p>El usuario recibe el <em>nonce</em>, lo cifra con su password, lo devuelve al servicio y este comprueba que el cifrado es correcto.</p><p></p><p>Podemos ver esta interacción con Wireshark:</p><p></p><p>Hacemos una petición desde DC01 por ejemplo:</p><p></p><p><img src="images/42-1.png" alt="images/42-1.png" /></p><p></p><p>Y capturamos lo siguiente:</p><p></p><p><img src="images/42-2.png" alt="images/42-2.png" /></p><p></p><p>DC01 envía la petición, WS01 devuelve el <em>challenge</em>.</p><p></p><p>Para poder crackear el hash NTLM que nos interesa necesitamos el <em>challenge</em> en plano y cifrado por lo que del segundo paquete lo extraemos en plano:</p><p></p><p><img src="images/42-3.png" alt="images/42-3.png" /></p><p></p><p><div class="codebox"><pre><br />Challenge--&gt; 15fd7d2681b5fcc6</pre></div></p><p></p><p>En el tercer paquete podemos ver la respuesta de DC01 a WS01 con el <em>challenge</em> cifrado.</p><p></p><p><img src="images/42-4.png" alt="images/42-4.png" /></p><p><img src="images/42-5.png" alt="images/42-5.png" /></p><p></p><p></p><p><div class="codebox"><pre><br />ChallengeTruncated--&gt; 811ffb4c156d792d759041755d36437e0101000000000000a7683e4ded6eda01ce6287bef18b59c3000000000200080043004f00520050000100080057005300300031000400140063006f00720070002e006c006f00630061006c0003001e0057005300300031002e0063006f00720070002e006c006f00630061006c000500140063006f00720070002e006c006f00630061006c0007000800a7683e4ded6eda0106000400020000000800300030000000000000000000000000300000574adf06c4204ead42a2b7fdf2104de04012845274b16e4da0cf7c0eea9322be0a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00320030002e003100330031000000000000000000</pre></div></p><p></p><p>También extraemos el nombre del usuario que realiza la petición, es muy sencillo porque va en plano dentro del paquete de autorización , ahí arriba lo podemos ver.</p><p></p><p><div class="codebox"><pre><br />user--&gt; administrador</pre></div></p><p></p><p></p><p>Ahora bien el formato que vamos a necesitar para convertir el valor truncado en el valor del <em>challenge</em> en plano es el siguiente:</p><p></p><p><div class="codebox"><pre><br />user--&gt; administrador<br />Challenge--&gt; 15fd7d2681b5fcc6<br />ChallengeTruncated--&gt; 811ffb4c156d792d759041755d36437e0101000000000000a7683e4ded6eda01ce6287bef18b59c3000000000200080043004f00520050000100080057005300300031000400140063006f00720070002e006c006f00630061006c0003001e0057005300300031002e0063006f00720070002e006c006f00630061006c000500140063006f00720070002e006c006f00630061006c0007000800a7683e4ded6eda0106000400020000000800300030000000000000000000000000300000574adf06c4204ead42a2b7fdf2104de04012845274b16e4da0cf7c0eea9322be0a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00320030002e003100330031000000000000000000<br /></pre></div></p><p></p><p><div class="codebox"><pre><br />UserName<span style="color:#000000;font-weight:700">:</span>Domain<span style="color:#000000;font-weight:700">:</span>NTLM_Server_Challenge<span style="color:#000000;font-weight:700">:</span>NTProofStr<span style="color:#000000;font-weight:700">:</span>NTMLv2Response-NTProofStr</pre></div></p><p></p><p><div class="codebox"><pre><br />Administrador<span style="color:#000000;font-weight:700">::</span>CORP<span style="color:#000000;font-weight:700">:</span>15fd7d2681b5fcc6<span style="color:#000000;font-weight:700">:</span>811ffb4c156d792d759041755d36437e<span style="color:#000000;font-weight:700">:</span>0101000000000000a7683e4ded6eda01ce6287bef18b59c3000000000200080043004f00520050000100080057005300300031000400140063006f00720070002e006c006f00630061006c0003001e0057005300300031002e0063006f00720070002e006c006f00630061006c000500140063006f00720070002e006c006f00630061006c0007000800a7683e4ded6eda0106000400020000000800300030000000000000000000000000300000574adf06c4204ead42a2b7fdf2104de04012845274b16e4da0cf7c0eea9322be0a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00320030002e003100330031000000000000000000</pre></div></p><p></p><p>Lo llevamos a Kali y lo crackeamos:</p><p></p><p><img src="images/42-6.png" alt="images/42-6.png" /></p><p></p><p></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
