<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Enumeración NTDS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Enumeración NTDS</h1><br/><p><h1>Haciendo peticiones a la base de datos del domino NTDS.dit</h1></p><p></p><p>Para comando básico con modulo de AD (la libreria que se añadió en la anterior sección) tenemos lo siguiente:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ADDomain</span></pre></div></p><p>Proporciona información general sobre el Active Directory, en concreto del dominio como SID, forest, master de la infraestructura “DC01.corp.local”</p><p><img src="images/18-1.png" alt="images/18-1.png" /></p><p></p><p>Para power view tenemos el comando:</p><p></p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetDomain</span></pre></div></p><p> </p><p> <img src="images/18-2.png" alt="images/18-2.png" /></p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-DomainPolicy</span><br />(<span style="color:#edd400;font-weight:400">Get-DomainPolicy</span>). <span style="color:#edd400;font-weight:400">&quot;SystemAccess&quot;</span> <br /></pre></div></p><p> </p><p> <img src="images/18-3.png" alt="images/18-3.png" /></p><p> <img src="images/18-4.png" alt="images/18-4.png" /></p><p> </p><p> Para obtener mas información sobre el controlador de dominio:</p><p> </p><p> → Modulo de AD</p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ADDomainController</span></pre></div></p><p> <img src="images/18-5.png" alt="images/18-5.png" /></p><p> </p><p> → Powerview</p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetDomainController</span></pre></div></p><p> <img src="images/18-6.png" alt="images/18-6.png" /></p><p> </p><p> </p><p> </p><p><h3> Es de tener en cuenta que el uso de powerview conlleva algunos riesgos a nivel de tráfico si nos encontramos con algun IDS como SNORT.</h3></p><p> </p><p> Si ejecutamos powerview y nos fijamos en SNORT:</p><p> <img src="images/18-7.png" alt="images/18-7.png" /></p><p> </p><p> Esto se debe a que las peticiones que implementa powerview o llamadas puede haber paquetes que no sean correctos del todo aunque no es un aviso alarmante desde un punto de vista del departamento de seguridad, pero hay que tener en cuenta que a nivel de red powerview deja algunas trazas en el tráfico de red.</p><p> </p><p> </p><p> </p><p> </p><p><h3> Ahora sabiendo el DNS del controlador de dominio, IP, etc así que vamos a recaudar información sobre los usuarios del domino</h3>:</p><p> </p><p> → Modulo AD</p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ADUser</span> <span style="color:#000000;font-weight:700">-Filter</span> <span style="color:#000000;font-weight:700">*</span></pre></div></p><p> </p><p> <img src="images/18-8.png" alt="images/18-8.png" /></p><p> </p><p> Obtenemos todos los usuarios pertenecientes al dominio.</p><p> </p><p> Si queremos filtrar:</p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ADUser</span> <span style="color:#000000;font-weight:700">-Filter</span> <span style="color:#000000;font-weight:700">*</span> | <span style="color:#729fcf;font-weight:400">select</span> Name,ObjectClass, ObjectGuid</pre></div></p><p> <img src="images/18-9.png" alt="images/18-9.png" /></p><p> </p><p> </p><p> → Powerview:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span></pre></div></p><p> </p><p> <img src="images/18-10.png" alt="images/18-10.png" /></p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetUser</span> | <span style="color:#729fcf;font-weight:400">select</span> name,lastlogoff,lastlogon</pre></div></p><p> </p><p> <img src="images/18-11.png" alt="images/18-11.png" /></p><p> </p><p> </p><p> </p><p> </p><p><h3> Ahora veremos información sobre los equipos del dominio</h3>:</p><p> </p><p> → Modulo AD</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ADComputer</span> <span style="color:#000000;font-weight:700">-Filter</span> <span style="color:#000000;font-weight:700">*</span> | <span style="color:#729fcf;font-weight:400">select</span> name,...</pre></div></p><p> <img src="images/18-12.png" alt="images/18-12.png" /></p><p> </p><p> </p><p> → Powerview:</p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetComputer</span> | <span style="color:#729fcf;font-weight:400">select</span> name,operatingsystemversion,...</pre></div></p><p> </p><p> <img src="images/18-13.png" alt="images/18-13.png" /></p><p> </p><p> Con powerview podemos saber que equipos están levantados:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetComputer</span> <span style="color:#000000;font-weight:700">-</span>Ping | <span style="color:#729fcf;font-weight:400">select</span> name,operatingsystem </pre></div></p><p> </p><p> <img src="images/18-14.png" alt="images/18-14.png" /></p><p> </p><p> </p><p> </p><p><h3> Otros objetos interesantes que obtener del Active Directory:</h3></p><p> </p><p> → powerview:</p><p> </p><p> Obtener grupos del dominio</p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-DomainGroup</span></pre></div></p><p> </p><p> Usuarios del grupo administradores:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetGroupMember</span></pre></div></p><p> </p><p> <img src="images/18-15.png" alt="images/18-15.png" /></p><p> </p><p> </p><p> Podemos identificar recursos compartidos:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Find-DomainShare</span></pre></div></p><p> </p><p> <img src="images/18-16.png" alt="images/18-16.png" /></p><p> </p><p> Hay que tener en cuenta que este comando si realiza un pequeño escaneo de la red y ser actividad un poco más intrusiva.</p><p> </p><p> </p><p> Para enumerar unidades organizativas:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetOU</span></pre></div></p><p> </p><p> <img src="images/18-17.png" alt="images/18-17.png" /></p><p> </p><p> GPO´S:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetGPO</span> | <span style="color:#729fcf;font-weight:400">select</span> displayname</pre></div></p><p> </p><p> Lista todas las policy del dominio, por ejemplo la que creamos anteriormente:</p><p> </p><p> <img src="images/18-18.png" alt="images/18-18.png" /></p><p> </p><p> Podemos pedir que GPO aplican a un equipo en concreto:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetGPO</span> <span style="color:#000000;font-weight:700">-</span>ComputerIdentity WS02</pre></div></p><p> </p><p> </p><p> </p><p> </p><p><h3> Algunos comandos más</h3>:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-ObjectAcl</span> <span style="color:#000000;font-weight:700">-</span>SamAccountName empleado1</pre></div></p><p> </p><p> Para obtener las access list de ese usuario en concreto.</p><p> </p><p> <img src="images/18-19.png" alt="images/18-19.png" /></p><p> </p><p> </p><p> Podemos recabar info sobre el forest:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Get-NetForestDomain</span></pre></div></p><p> </p><p> <img src="images/18-20.png" alt="images/18-20.png" /></p><p> </p><p><h2> Para mas comandos de Powerview : </h2><h2>https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/ad-enumeration</h2></p><p> </p><p> </p><p> Un comando más para encontrar que máquinas de dominio tienen un usuario administrador:</p><p> </p><p> <div class="codebox"><pre><br /><span style="color:#edd400;font-weight:400">Find-LocalAdminAccess</span> <span style="color:#ad7fa8;font-weight:400">-Verbose</span></pre></div></p><p> </p><p> <img src="images/18-21.png" alt="images/18-21.png" /></p><p> </p><p> </p><p> </p><p><strong><h1> Todo esto podremos hacerlo sin necesidad de tener acceso a un ordenador de la infraestructura, solo las credenciales y kali</h1></strong></p><p> </p><p> </p><p><h2> LDAPSEARCH:</h2></p><p> </p><p> El siguiente comando es un intento de sesión mediante unas credenciales que por defecto están deshabilitadas en la ldap que permiten conexión sin identificación así como en ftp se encuentra el anonymous.</p><p> </p><p> <div class="codebox"><pre><br />ldapsearch -X -h 192.168.20.5 -D <span style="color:#edd400;font-weight:400">&#39;&#39;</span> -W <span style="color:#edd400;font-weight:400">&#39;&#39;</span> -b <span style="color:#edd400;font-weight:400">&quot;DC=corp,DC=local&quot;</span> </pre></div></p><p> -x → modo de autenticación básico</p><p> -h → host donde se encuentra la base de datos</p><p> -D → nombre de usuario dentro del dominio</p><p> -w → contraseña</p><p> -b →con que objetos del dominio queremos interactuar.</p><p> </p><p> Sabiendo las credenciales que tenemos:</p><p> </p><p> <div class="codebox"><pre><br />ldapsearch -x -h 192.168.20.5 -D <span style="color:#edd400;font-weight:400">&#39;CORP\empleado1&#39;</span> -w <span style="color:#edd400;font-weight:400">&#39;Passw0rd1&#39;</span> -b <span style="color:#edd400;font-weight:400">&quot;DC=corp,DC=local&quot;</span> </pre></div></p><p> <div class="codebox"><pre><br />ldapsearch -x -h 192.168.20.5 -D <span style="color:#edd400;font-weight:400">&#39;CORP\empleado1&#39;</span> -w <span style="color:#edd400;font-weight:400">&#39;Passw0rd1&#39;</span> -b <span style="color:#edd400;font-weight:400">&quot;CN=Users,DC=corp,DC=local&quot;</span> </pre></div></p><p> <div class="codebox"><pre><br />ldapsearch -x -h 192.168.20.5 -D <span style="color:#edd400;font-weight:400">&#39;CORP\empleado1&#39;</span> -w <span style="color:#edd400;font-weight:400">&#39;Passw0rd1&#39;</span> -b <span style="color:#edd400;font-weight:400">&quot;CN=Administradores,CN=Builtin,DC=corp,DC=local&quot;</span> </pre></div></p><p> </p><p> </p><p><h2> PYWERVIEW:</h2></p><p> </p><p> De igual manera permite interactuar con la base de datos mediante LDAP:</p><p> </p><p> <div class="codebox"><pre><br />pywerview get-netdomaincontroller -u empleado1 --dc-ip 192.168.20.5 -p Passw0rd1</pre></div></p><p> Devuelve información relativa al controlador de dominio</p><p> </p><p> <img src="images/18-22.png" alt="images/18-22.png" /></p><p> </p><p> Para usuarios:</p><p>  <div class="codebox"><pre><br />pywerview get-netuser -u empleado1 --dc-ip 192.168.20.5 -p Passw0rd1</pre></div></p><p>  <img src="images/18-23.png" alt="images/18-23.png" /></p><p>  </p><p>  Para grupos:</p><p>  <div class="codebox"><pre><br />pywerview get-netgroup -u empleado1 --dc-ip 192.168.20.5 -p Passw0rd1</pre></div></p><p>  </p><p>  Para GPO:</p><p>  </p><p>  <div class="codebox"><pre><br />pywerview get-netgpo -u empleado1 --dc-ip 192.168.20.5 -p Passw0rd1</pre></div></p><p>  </p><p>  </p><p>  </p><p><h2>  JXPLORER</h2>:</p><p>  </p><p>  Para interactuar de forma gráfica:</p><p>  </p><p>  <div class="codebox"><pre><br />jxplorer</pre></div></p><p>  </p><p>  <img src="images/18-24.png" alt="images/18-24.png" /></p><p>  </p><p>  <img src="images/18-25.png" alt="images/18-25.png" /></p><p>  </p><p>  </p><p>  </p><p> </p><p> </p><p> </p><p> </p></div>
</body>
</html>
