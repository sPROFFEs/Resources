<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Autenticación y autorización en Windows</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Autenticación y autorización en Windows</h1><br/><p><h1>TÉCNICAS COMO SUPLANTACIÓN DE USUARIOS, MOVIMIENTOS LATERALES, ETC</h1></p><p></p><p></p><p></p><p><img src="images/34-1.png" alt="images/34-1.png" /></p><p></p><p>Este esquema representa el proceso de autenticación del sistema que se realiza en windows. </p><p></p><p>Cuando se intenta autenticar tenemos nuestra interfaz de usuario en la que introducimos nuestras credenciales, este proceso se comunica con el LocalSecurityAutority que recibe las credenciales y el paquete de autenticación a utilizar.</p><p></p><p>Si nos encontramos en una infraestructura de dominio el paquete será kerberos pero a nivel local el paquete será NTLM, por tanto el LSA llamará a la librería correspondiente.</p><p></p><p>A nivel local el sistema comprueba las credenciales contra una base de datos local manejada por el SAM.</p><p></p><p>Si en nuestra máquina queremos iniciar sesión con un usuario a nivel local, seleccionamos otro usuario e indicamos que el usuario está registrado a nivel local del la siguiente manera:</p><p></p><p><img src="images/34-2.png" alt="images/34-2.png" /></p><p></p><p><img src="images/34-3.png" alt="images/34-3.png" /></p><p></p><p></p><p></p><p></p><p><em><strong><h1>LSA LOGON SESSIONS</h1></strong></em></p><p><ul><li>Cuando un usuario se autentica correctamente, el paquete de autenticación (kerberos.dll o ntlm.dll) crea una <em>logon</em> <em>session</em> y devuelve información a la autoridad local LSA</li><li>El módulo LSA usa esta información para crear un <em><strong>Access</strong></em> <em><strong>Token</strong></em> </li><li>Este token incluye un identificador local único (LUID) para la <em>logon</em> <em>session</em> denominado identificador de inicio de sesión</li><li><a href="https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication#BKMK_CrentialInputForUserLogon">https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication#BKMK_CrentialInputForUserLogon</a></li></ul></p><p></p><p></p><p><h1>INTERACTIVE AUTHENTICATION</h1></p><p><ul><li>La autenticación es interactiva cuando se solicita al usuario que proporcione información de inicio de sesión como con un UI</li><li>La LSA realiza una autenticación interactiva cuando un usuario inicia sesión a traves de la interfaz de usuario GINA.</li><li>Si se realiza de manera correcta la autenticación, comienza la <em>logon</em> <em>session</em> del usuario y se <strong>guarda</strong> un conjunto de <strong>credenciales</strong> de inicio de sesión para futuras <strong>referencias</strong>. Esto se guarda en el módulo LSA para implementar el <em>SingleSignON</em></li><li><a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/interactive-authentication">https://learn.microsoft.com/en-us/windows/win32/secauthn/interactive-authentication</a></li></ul></p><p></p><p></p><p><h1>NON INTERACTIVE AUTHENTICATION</h1></p><p><ul><li>Al no ser interactiva solo se puede usar después de que se haya realizado una autenticación interactiva, es decir; es posterior </li><li>El usuario no introduce ningun tipo de dato de inicio de sesión; en su lugar se usan las credenciales establecidas y almacenadas en el módulo LSA previamente.</li><li>Esto se utiliza para consumir servicios en red y conectar máquinas sin tener que volver a introducir credenciales.</li><li><a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/noninteractive-authentication">https://learn.microsoft.com/en-us/windows/win32/secauthn/noninteractive-authentication</a></li></ul></p><p></p><p>De forma práctica podemos ver esto en nuestra WS01 ya que como tenemos una sesión iniciada de forma local, hemos pasado esa autenticación interactiva y ahora podemos ver esa logon session y el access token asociados.</p><p></p><p>Microsoft ofrece una serie de herramientas de administración entre las que se encuentra una para visualizar las Loggonsessions: <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/logonsessions">https://learn.microsoft.com/en-us/sysinternals/downloads/logonsessions</a></p><p></p><p><img src="images/34-4.png" alt="images/34-4.png" /></p><p></p><p>Como bien sabemos para esta herramienta se necesitan privilegios de administración, como este usuario es a nivel local se encuentra dentro del grupo administradores porque es el que se creó inicialmente con la máquina.</p><p><img src="images/34-5.png" alt="images/34-5.png" /></p><p><img src="images/34-6.png" alt="images/34-6.png" /></p><p></p><p><img src="images/34-7.png" alt="images/34-7.png" /></p><p></p><p>Ejecutamos el archivo .exe:</p><p></p><p><img src="images/34-8.png" alt="images/34-8.png" /></p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>logonsessions.exe</pre></div></p><p></p><p><img src="images/34-9.png" alt="images/34-9.png" /></p><p></p><p>Si nos fijamos este usuario local tiene dos LogonSession creadas al mismo tiempo, ya que van asociadas a un AccessToken. Lo normal al autenticarse se crean dos sesiones para ese usuario, una con los privilegios que tiene este y otra con privilegios elevados ya que al iniciar el sistema algunos servicios necesitan de estos para ser ejecutados.</p><p></p><p><div class="codebox"><pre><br />.<span style="color:#000000;font-weight:700">\</span>logonsessions.exe <span style="color:#000000;font-weight:700">-</span>p</pre></div></p><p></p><p>Si ejecutamos ese parámetro veremos los procesos que hay asociados a cada una de esas LogonSessions.</p><p></p><p><img src="images/34-10.png" alt="images/34-10.png" /></p><p>Esta sesion ejecuta los procesos que necesitan de privilegios elevados</p><p></p><p><img src="images/34-11.png" alt="images/34-11.png" /></p><p>Esta otra los demas procesos que no son necesarios de privilegios elevados.</p><p></p><p>Como bien hemos visto antes estas dos sesiones tienen un token de acceso o AccessToken que les permite autorizar el acceso a diferentes objetos.</p><p></p><p>Vamos a ver una cosa curiosa, vamos a iniciar sesión de nuevo en un usuario de dominio:</p><p></p><p>Iniciamos un powershell como administrador:</p><p><img src="images/34-12.png" alt="images/34-12.png" /></p><p></p><p>Ejecutamos loggonsessions.exe</p><p></p><p><img src="images/34-13.png" alt="images/34-13.png" /></p><p></p><p>Si nos fijamos en las dos últimas sesiones:</p><p><img src="images/34-14.png" alt="images/34-14.png" /></p><p></p><p>Son las dos sesiones que acabamos de crear, la de empleado1 de forma interactiva y la de administrador de forma interactiva pero veis que es otro tipo de interacción debido a que ha sido un prompt de ejecución de permisos y no un inicio de sesión como tal pero, como igualmente hemos interactuado como tal ya que hemos introducido las credenciales de administrador es interactivo. </p><p></p><p>Ahora bien, si vamos al DC01 y accedemos desde un powershell a el disco de WS01:</p><p></p><p><img src="images/34-15.png" alt="images/34-15.png" /></p><p></p><p>Estamos dentro de sus archivos pero ni siquiera nos hemos autenticado cierto?</p><p></p><p>Veamos de nuevo las logon sessions en WS01.</p><p></p><p><img src="images/34-16.png" alt="images/34-16.png" /></p><p></p><p>En último lugar veremos un acceso de administrador al equipo pero su tipo de inicio ha sido network y no interactivo.</p><p>Esto es importante porque cuando tenemos un logon interactivo en algún lugar de la memoria ram están las credenciales de los usuarios que han interactuado, como puede ser empleado1 o administrador al iniciar el powershell ambas almacenadas en el LSA.</p><p></p><p>Sin embargo en las sesiones de network o red no se almacenan las credenciales en la ram o LSA del equipo.</p><p></p><p><h1>ACCESS TOKEN</h1></p><p><ul><li>Cuando un usuario inicia sesión, el sistema comprueba la contaseña con la base de datos de seguridad. Si se autentica correctamente, el sistema genera un AccessToken y cada proceso ejecutado en nombre de ese usuario tiene una copia de ese token de acceso.</li><li>Un token de acceso es en si un objeto que describe el contexto de seguridad de un proceso o subproceso.</li><li>La información de un token incluye la identidad y los privilegios de la cuenta de usuario asociada al proceso o subproceso.</li><li>El sistema usa un token para identificar el usuario cuando un subproceso interactúa con un <em>securable</em> <em>object</em> o intenta realizar una tarea del sistema que requiere privilegios.</li><li><a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/access-tokens">https://learn.microsoft.com/en-us/windows/win32/secauthz/access-tokens</a></li></ul></p><p><ul><li>Cada proceso tiene un token principal asociado que describe el contexto de seguridad asociado al proceso</li><li>De forma predeterminada el sistema usa el token principal cuando un subproceso del proceso interactúa con un securable object.</li><li>Además, un subproceso puede suplantar una cuenta de cliente y esto permite que el subproceso interactue con securable objetcts mediante el contexto de seguridad del cliente.</li><li>Un subproceso que suplanta a un cliente tiene un token principal y un token de suplantación.</li></ul></p><p></p><p>Por tanto de todo esto sacamos que existen dos tipos de tokens:<ul><li>Principal: el que tiene por defecto el proceso y todo subproceso (a no se que se esté suplantando)</li><li>Token suplantación: que suplanta al usuario y que suele utilizar en arquitecturas cliente-servidor.</li></ul></p><p></p><p></p><p></p><p></p><p></p><p></p><p>Volvemos a WS01 con empleado1:</p><p></p><p><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer</a></p><p></p><p>Abrimos un powershell como adminstrador y otro como empleado1.</p><p></p><p>En el processexplorer administrador vemos dos procesos powershell:</p><p></p><p><img src="images/34-17.png" alt="images/34-17.png" /></p><p></p><p><img src="images/34-18.png" alt="images/34-18.png" /></p><p></p><p>Aquí observamos las diferencias de privilegios, las diferentes logonsessions que usan y los usuarios relacionados con estos procesos.</p><p></p><p>Estos tokens de acceso son los que validan cuando la ejecución puede o no puede hacer algo según sus privilegios.</p></div>
</body>
</html>
